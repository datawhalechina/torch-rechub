<!DOCTYPE html>
<html lang="zh-CN" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>å‘é‡æ£€ç´¢å°è£… | torch-rechub</title>
    <meta name="description" content="Torch-RecHub å‘é‡æ£€ç´¢å·¥å…·">
    <meta name="generator" content="VitePress v2.0.0-alpha.15">
    <link rel="preload stylesheet" href="/torch-rechub/assets/style.Dnbe36Wi.css" as="style">
    <link rel="preload stylesheet" href="/torch-rechub/vp-icons.css" as="style">
    
    <script type="module" src="/torch-rechub/assets/app.BZnlXBsY.js"></script>
    <link rel="preload" href="/torch-rechub/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/torch-rechub/assets/chunks/theme.CMGEuUz9.js">
    <link rel="modulepreload" href="/torch-rechub/assets/chunks/framework.CFr_S-Bc.js">
    <link rel="modulepreload" href="/torch-rechub/assets/zh_serving_vector_index.md.B2v0WA5L.lean.js">
    <link rel="icon" href="/torch-rechub/favicon.ico">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-1df9f90f><!--[--><!--]--><!--[--><span tabindex="-1" data-v-331ec75c></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-331ec75c>Skip to content</a><!--]--><!----><header class="VPNav" data-v-1df9f90f data-v-da52a441><div class="VPNavBar" data-v-da52a441 data-v-70946a35><div class="wrapper" data-v-70946a35><div class="container" data-v-70946a35><div class="title" data-v-70946a35><div class="VPNavBarTitle has-sidebar" data-v-70946a35 data-v-1e38c6bc><a class="title" href="/torch-rechub/zh/" data-v-1e38c6bc><!--[--><!--]--><!--[--><img class="VPImage logo" src="/torch-rechub/img/logo.png" alt data-v-8426fc1a><!--]--><span data-v-1e38c6bc>torch-rechub</span><!--[--><!--]--></a></div></div><div class="content" data-v-70946a35><div class="content-body" data-v-70946a35><!--[--><!--]--><div class="VPNavBarSearch search" data-v-70946a35><!--[--><!----><div id="local-search"><button type="button" aria-label="Search" aria-keyshortcuts="/ control+k meta+k" class="DocSearch DocSearch-Button"><span class="DocSearch-Button-Container"><span class="vpi-search DocSearch-Search-Icon"></span><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key"></kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-70946a35 data-v-39714824><span id="main-nav-aria-label" class="visually-hidden" data-v-39714824> Main Navigation </span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/torch-rechub/zh/" tabindex="0" data-v-39714824 data-v-52a1d768><!--[--><span data-v-52a1d768>ğŸ  é¦–é¡µ</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/torch-rechub/zh/guide/intro.html" tabindex="0" data-v-39714824 data-v-52a1d768><!--[--><span data-v-52a1d768>ğŸš€ å¿«é€Ÿå…¥é—¨</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/torch-rechub/zh/core/intro.html" tabindex="0" data-v-39714824 data-v-52a1d768><!--[--><span data-v-52a1d768>âš™ï¸ æ ¸å¿ƒç»„ä»¶</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/torch-rechub/zh/models/intro.html" tabindex="0" data-v-39714824 data-v-52a1d768><!--[--><span data-v-52a1d768>ğŸ° æ¨¡å‹åº“</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/torch-rechub/zh/tools/intro.html" tabindex="0" data-v-39714824 data-v-52a1d768><!--[--><span data-v-52a1d768>ğŸ› ï¸ ç ”å‘å·¥å…·</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/torch-rechub/zh/serving/intro.html" tabindex="0" data-v-39714824 data-v-52a1d768><!--[--><span data-v-52a1d768>ğŸš€ ç”Ÿäº§éƒ¨ç½²</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/torch-rechub/zh/tutorials/intro.html" tabindex="0" data-v-39714824 data-v-52a1d768><!--[--><span data-v-52a1d768>ğŸ“– åœºæ™¯æ•™ç¨‹</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/torch-rechub/zh/api/api.html" tabindex="0" data-v-39714824 data-v-52a1d768><!--[--><span data-v-52a1d768>â„¹ï¸ API</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/torch-rechub/zh/community/faq.html" tabindex="0" data-v-39714824 data-v-52a1d768><!--[--><span data-v-52a1d768>ğŸ‘¥ ç¤¾åŒº</span><!--]--></a><!--]--><!--]--></nav><div class="VPFlyout VPNavBarTranslations translations" data-v-70946a35 data-v-4c1766e2 data-v-42cb505d><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="Change language" data-v-42cb505d><span class="text" data-v-42cb505d><span class="vpi-languages option-icon" data-v-42cb505d></span><!----><span class="vpi-chevron-down text-icon" data-v-42cb505d></span></span></button><div class="menu" data-v-42cb505d><div class="VPMenu" data-v-42cb505d data-v-25a6cce8><!----><!--[--><!--[--><div class="items" data-v-4c1766e2><p class="title" data-v-4c1766e2>ä¸­æ–‡</p><!--[--><div class="VPMenuLink" data-v-4c1766e2 data-v-faf5b206><a class="VPLink link" href="/torch-rechub/serving/vector_index.html" lang="en" data-v-faf5b206><!--[--><span data-v-faf5b206>English</span><!--]--></a></div><!--]--></div><!--]--><!--]--></div></div></div><div class="VPNavBarAppearance appearance" data-v-70946a35 data-v-6c893767><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-6c893767 data-v-5337faa4 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-5337faa4></span><span class="vpi-moon moon" data-v-5337faa4></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-70946a35 data-v-0394ad82 data-v-d07f11e6><!--[--><a class="VPSocialLink no-icon" href="https://github.com/datawhalechina/torch-rechub" aria-label="github" target="_blank" rel="me noopener" data-v-d07f11e6 data-v-591a6b30><span class="vpi-social-github"></span></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-70946a35 data-v-bf2fac68 data-v-42cb505d><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-42cb505d><span class="vpi-more-horizontal icon" data-v-42cb505d></span></button><div class="menu" data-v-42cb505d><div class="VPMenu" data-v-42cb505d data-v-25a6cce8><!----><!--[--><!--[--><div class="group translations" data-v-bf2fac68><p class="trans-title" data-v-bf2fac68>ä¸­æ–‡</p><!--[--><div class="VPMenuLink" data-v-bf2fac68 data-v-faf5b206><a class="VPLink link" href="/torch-rechub/serving/vector_index.html" lang="en" data-v-faf5b206><!--[--><span data-v-faf5b206>English</span><!--]--></a></div><!--]--></div><div class="group" data-v-bf2fac68><div class="item appearance" data-v-bf2fac68><p class="label" data-v-bf2fac68>Appearance</p><div class="appearance-action" data-v-bf2fac68><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-bf2fac68 data-v-5337faa4 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-5337faa4></span><span class="vpi-moon moon" data-v-5337faa4></span><!--]--></span></span></button></div></div></div><div class="group" data-v-bf2fac68><div class="item social-links" data-v-bf2fac68><div class="VPSocialLinks social-links-list" data-v-bf2fac68 data-v-d07f11e6><!--[--><a class="VPSocialLink no-icon" href="https://github.com/datawhalechina/torch-rechub" aria-label="github" target="_blank" rel="me noopener" data-v-d07f11e6 data-v-591a6b30><span class="vpi-social-github"></span></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-70946a35 data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div></div><div class="divider" data-v-70946a35><div class="divider-line" data-v-70946a35></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-1df9f90f data-v-db738f89><div class="container" data-v-db738f89><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-db738f89><span class="vpi-align-left menu-icon" data-v-db738f89></span><span class="menu-text" data-v-db738f89>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-db738f89 data-v-0bf0e06f><button data-v-0bf0e06f>Return to top</button><!----></div></div></div><aside class="VPSidebar" data-v-1df9f90f data-v-af661f50><div class="curtain" data-v-af661f50></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-af661f50><span class="visually-hidden" id="sidebar-aria-label" data-v-af661f50> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="no-transition group" data-v-8d50c081><section class="VPSidebarItem level-0 has-active" data-v-8d50c081 data-v-d81de50c><div class="item" role="button" tabindex="0" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><h2 class="text" data-v-d81de50c>ğŸš€ ç”Ÿäº§éƒ¨ç½²</h2><!----></div><div class="items" data-v-d81de50c><!--[--><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/torch-rechub/zh/serving/intro.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>å¯¼è§ˆ (Overview)</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/torch-rechub/zh/serving/onnx.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>ONNX å¯¼å‡ºä¸é‡åŒ–</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/torch-rechub/zh/serving/vector_index.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>å‘é‡æ£€ç´¢å°è£…</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/torch-rechub/zh/serving/demo.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>åœ¨çº¿æœåŠ¡ç¤ºä¾‹</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-1df9f90f data-v-c87f25bf><div class="VPDoc has-sidebar has-aside" data-v-c87f25bf data-v-7011f0d8><!--[--><!--]--><div class="container" data-v-7011f0d8><div class="aside" data-v-7011f0d8><div class="aside-curtain" data-v-7011f0d8></div><div class="aside-container" data-v-7011f0d8><div class="aside-content" data-v-7011f0d8><div class="VPDocAside" data-v-7011f0d8 data-v-3f215769><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-3f215769 data-v-60d5052e><div class="content" data-v-60d5052e><div class="outline-marker" data-v-60d5052e></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-60d5052e>On this page</div><ul class="VPDocOutlineItem root" data-v-60d5052e data-v-1ce71065><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-3f215769></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-7011f0d8><div class="content-container" data-v-7011f0d8><!--[--><!--]--><main class="main" data-v-7011f0d8><div style="position:relative;" class="vp-doc _torch-rechub_zh_serving_vector_index" data-v-7011f0d8><div><h1 id="å‘é‡æ£€ç´¢å°è£…" tabindex="-1">å‘é‡æ£€ç´¢å°è£… <a class="header-anchor" href="#å‘é‡æ£€ç´¢å°è£…" aria-label="Permalink to â€œå‘é‡æ£€ç´¢å°è£…â€">â€‹</a></h1><p>Torch-RecHub æä¾›äº†ç»Ÿä¸€çš„å‘é‡æ£€ç´¢æ¥å£ï¼Œæ”¯æŒä¸‰ç§ä¸»æµçš„è¿‘ä¼¼æœ€è¿‘é‚»ï¼ˆANNï¼‰æ£€ç´¢åº“ï¼š<strong>Annoy</strong>ã€<strong>FAISS</strong> å’Œ <strong>Milvus</strong>ã€‚é€šè¿‡æ ‡å‡†åŒ–çš„ Builder-Indexer æ¨¡å¼ï¼Œç”¨æˆ·å¯ä»¥æ–¹ä¾¿åœ°åœ¨ä¸åŒæ£€ç´¢åç«¯ä¹‹é—´åˆ‡æ¢ã€‚</p><h2 id="å¿«é€Ÿå¼€å§‹" tabindex="-1">å¿«é€Ÿå¼€å§‹ <a class="header-anchor" href="#å¿«é€Ÿå¼€å§‹" aria-label="Permalink to â€œå¿«é€Ÿå¼€å§‹â€">â€‹</a></h2><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch_rechub.serving </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> builder_factory</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># å‡†å¤‡åµŒå…¥å‘é‡</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">item_embeddings </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch.randn(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">64</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">dtype</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">torch.float32)  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 1000ä¸ªç‰©å“ï¼Œ64ç»´</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">user_embeddings </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch.randn(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">64</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">dtype</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">torch.float32)    </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 10ä¸ªç”¨æˆ·ï¼Œ64ç»´</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># åˆ›å»º Builder å¹¶æ„å»ºç´¢å¼•</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">builder </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> builder_factory(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;faiss&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">index_type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Flat&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">metric</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;L2&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">with</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> builder.from_embeddings(item_embeddings) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> indexer:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # æŸ¥è¯¢ Top-K</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ids, distances </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> indexer.query(user_embeddings, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">top_k</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # ä¿å­˜ç´¢å¼•</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    indexer.save(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;item.index&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># åŠ è½½å·²æœ‰ç´¢å¼•</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">with</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> builder.from_index_file(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;item.index&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> indexer:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ids, distances </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> indexer.query(user_embeddings, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">top_k</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><h2 id="æ ¸å¿ƒæ¦‚å¿µ" tabindex="-1">æ ¸å¿ƒæ¦‚å¿µ <a class="header-anchor" href="#æ ¸å¿ƒæ¦‚å¿µ" aria-label="Permalink to â€œæ ¸å¿ƒæ¦‚å¿µâ€">â€‹</a></h2><h3 id="builder-indexer-æ¨¡å¼" tabindex="-1">Builder-Indexer æ¨¡å¼ <a class="header-anchor" href="#builder-indexer-æ¨¡å¼" aria-label="Permalink to â€œBuilder-Indexer æ¨¡å¼â€">â€‹</a></h3><ul><li><strong>Builder</strong>ï¼šè´Ÿè´£ç´¢å¼•çš„æ„å»ºé…ç½®ï¼Œé€šè¿‡ <code>builder_factory</code> å·¥å‚å‡½æ•°åˆ›å»º</li><li><strong>Indexer</strong>ï¼šè´Ÿè´£å…·ä½“çš„æŸ¥è¯¢å’Œä¿å­˜æ“ä½œï¼Œé€šè¿‡ Builder çš„ä¸Šä¸‹æ–‡ç®¡ç†å™¨è·å–</li></ul><h3 id="å·¥å‚å‡½æ•°" tabindex="-1">å·¥å‚å‡½æ•° <a class="header-anchor" href="#å·¥å‚å‡½æ•°" aria-label="Permalink to â€œå·¥å‚å‡½æ•°â€">â€‹</a></h3><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch_rechub.serving </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> builder_factory</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">builder </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> builder_factory(model, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">builder_config)</span></span></code></pre></div><table tabindex="0"><thead><tr><th>å‚æ•°</th><th>ç±»å‹</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>model</code></td><td><code>str</code></td><td>æ£€ç´¢åç«¯åç§°ï¼š<code>&quot;annoy&quot;</code>ã€<code>&quot;faiss&quot;</code> æˆ– <code>&quot;milvus&quot;</code></td></tr><tr><td><code>**builder_config</code></td><td><code>dict</code></td><td>ä¼ é€’ç»™å…·ä½“ Builder çš„é…ç½®å‚æ•°</td></tr></tbody></table><hr><h2 id="annoy" tabindex="-1">Annoy <a class="header-anchor" href="#annoy" aria-label="Permalink to â€œAnnoyâ€">â€‹</a></h2><p><a href="https://github.com/spotify/annoy" target="_blank" rel="noreferrer">Annoy</a>ï¼ˆApproximate Nearest Neighbors Oh Yeahï¼‰æ˜¯ Spotify å¼€æºçš„è¿‘ä¼¼æœ€è¿‘é‚»æœç´¢åº“ï¼Œç‰¹ç‚¹æ˜¯å†…å­˜å‹å¥½ã€æ”¯æŒæ–‡ä»¶å†…å­˜æ˜ å°„ã€‚</p><h3 id="å®‰è£…" tabindex="-1">å®‰è£… <a class="header-anchor" href="#å®‰è£…" aria-label="Permalink to â€œå®‰è£…â€">â€‹</a></h3><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pip</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> annoy</span></span></code></pre></div><blockquote><p>âš ï¸ <strong>æ³¨æ„</strong>ï¼šAnnoy æ˜¯ C++ åº“ï¼Œå®‰è£…æ—¶éœ€è¦ç¼–è¯‘ã€‚å¦‚æœä½ çš„ç³»ç»Ÿæ²¡æœ‰ C++ ç¼–è¯‘ç¯å¢ƒï¼ˆå¦‚ Windows ä¸Šç¼ºå°‘ Visual Studio Build Toolsï¼‰ï¼Œå¯èƒ½ä¼šé‡åˆ°ç¼–è¯‘é”™è¯¯ã€‚</p><p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p><ul><li><strong>Linux/macOS</strong>ï¼šç¡®ä¿å®‰è£…äº† <code>gcc</code>/<code>g++</code> æˆ– <code>clang</code></li><li><strong>Windows</strong>ï¼šå®‰è£… <a href="https://visualstudio.microsoft.com/visual-cpp-build-tools/" target="_blank" rel="noreferrer">Visual Studio Build Tools</a>ï¼Œæˆ–ç›´æ¥ä¸‹è½½é¢„ç¼–è¯‘çš„ wheel æ–‡ä»¶ï¼š <ul><li>é¢„ç¼–è¯‘ wheel ä¸‹è½½åœ°å€ï¼š<a href="https://github.com/Sprocketer/annoy-wheels" target="_blank" rel="noreferrer">https://github.com/Sprocketer/annoy-wheels</a></li><li>æ ¹æ®ä½ çš„ Python ç‰ˆæœ¬ä¸‹è½½å¯¹åº”çš„ <code>.whl</code> æ–‡ä»¶ï¼Œç„¶åæœ¬åœ°å®‰è£…ï¼š<div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pip</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> annoy-1.17.3-cp311-cp311-win_amd64.whl</span></span></code></pre></div></li></ul></li></ul></blockquote><h3 id="å‚æ•°è¯´æ˜" tabindex="-1">å‚æ•°è¯´æ˜ <a class="header-anchor" href="#å‚æ•°è¯´æ˜" aria-label="Permalink to â€œå‚æ•°è¯´æ˜â€">â€‹</a></h3><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">builder </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> builder_factory(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;annoy&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    d</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">64</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,                    </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># å‘é‡ç»´åº¦ï¼ˆå¿…éœ€ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    metric</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;angular&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,        </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># è·ç¦»åº¦é‡</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    n_trees</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,              </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># æ ‘çš„æ•°é‡</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    threads</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,              </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># æ„å»ºæ—¶çš„çº¿ç¨‹æ•°</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    searchk</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,              </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># æœç´¢æ—¶æ£€æŸ¥çš„èŠ‚ç‚¹æ•°</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><table tabindex="0"><thead><tr><th>å‚æ•°</th><th>ç±»å‹</th><th>é»˜è®¤å€¼</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>d</code></td><td><code>int</code></td><td>å¿…éœ€</td><td>å‘é‡ç»´åº¦</td></tr><tr><td><code>metric</code></td><td><code>str</code></td><td><code>&quot;angular&quot;</code></td><td>è·ç¦»åº¦é‡ï¼š<code>&quot;angular&quot;</code>ï¼ˆä½™å¼¦ï¼‰ã€<code>&quot;euclidean&quot;</code>ï¼ˆæ¬§æ°ï¼‰ã€<code>&quot;dot&quot;</code>ï¼ˆç‚¹ç§¯ï¼‰</td></tr><tr><td><code>n_trees</code></td><td><code>int</code></td><td><code>10</code></td><td>æ„å»ºçš„æ ‘æ•°é‡ï¼Œè¶Šå¤šç²¾åº¦è¶Šé«˜ä½†æ„å»ºè¶Šæ…¢</td></tr><tr><td><code>threads</code></td><td><code>int</code></td><td><code>-1</code></td><td>æ„å»ºçº¿ç¨‹æ•°ï¼Œ<code>-1</code> è¡¨ç¤ºä½¿ç”¨æ‰€æœ‰å¯ç”¨æ ¸å¿ƒ</td></tr><tr><td><code>searchk</code></td><td><code>int</code></td><td><code>-1</code></td><td>æœç´¢æ—¶æ£€æŸ¥çš„èŠ‚ç‚¹æ•°ï¼Œ<code>-1</code> è¡¨ç¤º <code>n_trees * top_k</code></td></tr></tbody></table><h3 id="ä½¿ç”¨ç¤ºä¾‹" tabindex="-1">ä½¿ç”¨ç¤ºä¾‹ <a class="header-anchor" href="#ä½¿ç”¨ç¤ºä¾‹" aria-label="Permalink to â€œä½¿ç”¨ç¤ºä¾‹â€">â€‹</a></h3><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch_rechub.serving </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> builder_factory</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">item_embeddings </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch.randn(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">64</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">dtype</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">torch.float32)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">user_embeddings </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch.randn(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">64</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">dtype</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">torch.float32)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ä½¿ç”¨ä½™å¼¦ç›¸ä¼¼åº¦</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">builder </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> builder_factory(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;annoy&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    d</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">64</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    metric</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;angular&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    n_trees</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">50</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    searchk</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">with</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> builder.from_embeddings(item_embeddings) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> indexer:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ids, distances </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> indexer.query(user_embeddings, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">top_k</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    indexer.save(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;annoy.index&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;å¬å›ç‰©å“ID: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ids</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;è·ç¦»: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">distances</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><hr><h2 id="faiss" tabindex="-1">FAISS <a class="header-anchor" href="#faiss" aria-label="Permalink to â€œFAISSâ€">â€‹</a></h2><p><a href="https://github.com/facebookresearch/faiss" target="_blank" rel="noreferrer">FAISS</a>ï¼ˆFacebook AI Similarity Searchï¼‰æ˜¯ Meta å¼€æºçš„é«˜æ€§èƒ½ç›¸ä¼¼æ€§æœç´¢åº“ï¼Œæ”¯æŒ GPU åŠ é€Ÿå’Œå¤šç§ç´¢å¼•ç±»å‹ã€‚</p><h3 id="å®‰è£…-1" tabindex="-1">å®‰è£… <a class="header-anchor" href="#å®‰è£…-1" aria-label="Permalink to â€œå®‰è£…â€">â€‹</a></h3><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># CPU ç‰ˆæœ¬</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pip</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> faiss-cpu</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># GPU ç‰ˆæœ¬ï¼ˆéœ€è¦ CUDAï¼‰</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pip</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> faiss-gpu</span></span></code></pre></div><h3 id="æ”¯æŒçš„ç´¢å¼•ç±»å‹" tabindex="-1">æ”¯æŒçš„ç´¢å¼•ç±»å‹ <a class="header-anchor" href="#æ”¯æŒçš„ç´¢å¼•ç±»å‹" aria-label="Permalink to â€œæ”¯æŒçš„ç´¢å¼•ç±»å‹â€">â€‹</a></h3><table tabindex="0"><thead><tr><th>ç´¢å¼•ç±»å‹</th><th>è¯´æ˜</th><th>é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td><code>Flat</code></td><td>æš´åŠ›æœç´¢ï¼Œç²¾ç¡®ç»“æœ</td><td>å°è§„æ¨¡æ•°æ®ï¼ˆ&lt; 10ä¸‡ï¼‰</td></tr><tr><td><code>HNSW</code></td><td>åŸºäºå›¾çš„è¿‘ä¼¼æœç´¢</td><td>ä¸­ç­‰è§„æ¨¡ï¼Œé«˜å¬å›ç‡è¦æ±‚</td></tr><tr><td><code>IVF</code></td><td>å€’æ’ç´¢å¼•ï¼Œèšç±»åæœç´¢</td><td>å¤§è§„æ¨¡æ•°æ®</td></tr></tbody></table><h3 id="å‚æ•°è¯´æ˜-1" tabindex="-1">å‚æ•°è¯´æ˜ <a class="header-anchor" href="#å‚æ•°è¯´æ˜-1" aria-label="Permalink to â€œå‚æ•°è¯´æ˜â€">â€‹</a></h3><h4 id="flat-ç´¢å¼•" tabindex="-1">Flat ç´¢å¼• <a class="header-anchor" href="#flat-ç´¢å¼•" aria-label="Permalink to â€œFlat ç´¢å¼•â€">â€‹</a></h4><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">builder </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> builder_factory(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;faiss&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    index_type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Flat&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,       </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ç´¢å¼•ç±»å‹</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    metric</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;L2&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,             </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># è·ç¦»åº¦é‡</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><table tabindex="0"><thead><tr><th>å‚æ•°</th><th>ç±»å‹</th><th>é»˜è®¤å€¼</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>index_type</code></td><td><code>str</code></td><td><code>&quot;Flat&quot;</code></td><td>ç´¢å¼•ç±»å‹</td></tr><tr><td><code>metric</code></td><td><code>str</code></td><td><code>&quot;L2&quot;</code></td><td>è·ç¦»åº¦é‡ï¼š<code>&quot;L2&quot;</code>ï¼ˆæ¬§æ°è·ç¦»ï¼‰ã€<code>&quot;IP&quot;</code>ï¼ˆå†…ç§¯ï¼‰</td></tr></tbody></table><h4 id="hnsw-ç´¢å¼•" tabindex="-1">HNSW ç´¢å¼• <a class="header-anchor" href="#hnsw-ç´¢å¼•" aria-label="Permalink to â€œHNSW ç´¢å¼•â€">â€‹</a></h4><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">builder </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> builder_factory(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;faiss&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    index_type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;HNSW&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    metric</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;L2&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    m</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,                    </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># æ¯ä¸ªèŠ‚ç‚¹çš„æœ€å¤§é‚»å±…æ•°</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    efSearch</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">50</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,             </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># æœç´¢æ—¶çš„å€™é€‰èŠ‚ç‚¹æ•°</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><table tabindex="0"><thead><tr><th>å‚æ•°</th><th>ç±»å‹</th><th>é»˜è®¤å€¼</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>m</code></td><td><code>int</code></td><td><code>32</code></td><td>æ¯ä¸ªèŠ‚ç‚¹çš„æœ€å¤§é‚»å±…æ•°ï¼Œè¶Šå¤§ç²¾åº¦è¶Šé«˜</td></tr><tr><td><code>efSearch</code></td><td><code>int</code></td><td><code>None</code></td><td>æœç´¢æ—¶çš„å€™é€‰èŠ‚ç‚¹æ•°ï¼Œè¶Šå¤§ç²¾åº¦è¶Šé«˜ä½†è¶Šæ…¢</td></tr></tbody></table><h4 id="ivf-ç´¢å¼•" tabindex="-1">IVF ç´¢å¼• <a class="header-anchor" href="#ivf-ç´¢å¼•" aria-label="Permalink to â€œIVF ç´¢å¼•â€">â€‹</a></h4><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">builder </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> builder_factory(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;faiss&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    index_type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;IVF&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    metric</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;L2&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    nlists</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,              </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># èšç±»ä¸­å¿ƒæ•°é‡</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    nprobe</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,               </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># æœç´¢æ—¶è®¿é—®çš„èšç±»æ•°</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><table tabindex="0"><thead><tr><th>å‚æ•°</th><th>ç±»å‹</th><th>é»˜è®¤å€¼</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>nlists</code></td><td><code>int</code></td><td><code>100</code></td><td>èšç±»ä¸­å¿ƒæ•°é‡ï¼Œå»ºè®®ä¸º <code>sqrt(n)</code> åˆ° <code>4*sqrt(n)</code></td></tr><tr><td><code>nprobe</code></td><td><code>int</code></td><td><code>None</code></td><td>æœç´¢æ—¶è®¿é—®çš„èšç±»æ•°ï¼Œè¶Šå¤§ç²¾åº¦è¶Šé«˜ä½†è¶Šæ…¢</td></tr></tbody></table><h3 id="ä½¿ç”¨ç¤ºä¾‹-1" tabindex="-1">ä½¿ç”¨ç¤ºä¾‹ <a class="header-anchor" href="#ä½¿ç”¨ç¤ºä¾‹-1" aria-label="Permalink to â€œä½¿ç”¨ç¤ºä¾‹â€">â€‹</a></h3><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch_rechub.serving </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> builder_factory</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">item_embeddings </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch.randn(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">128</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">dtype</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">torch.float32)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">user_embeddings </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch.randn(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">128</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">dtype</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">torch.float32)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ä½¿ç”¨ HNSW ç´¢å¼•</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">builder </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> builder_factory(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;faiss&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    index_type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;HNSW&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    metric</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;IP&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># å†…ç§¯ï¼Œé€‚åˆå½’ä¸€åŒ–åçš„å‘é‡</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    m</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    efSearch</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">64</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">with</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> builder.from_embeddings(item_embeddings) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> indexer:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ids, distances </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> indexer.query(user_embeddings, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">top_k</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    indexer.save(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;faiss_hnsw.index&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><hr><h2 id="milvus" tabindex="-1">Milvus <a class="header-anchor" href="#milvus" aria-label="Permalink to â€œMilvusâ€">â€‹</a></h2><p><a href="https://milvus.io/" target="_blank" rel="noreferrer">Milvus</a> æ˜¯ä¸€ä¸ªäº‘åŸç”Ÿå‘é‡æ•°æ®åº“ï¼Œæ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²å’Œå¤šç§ç´¢å¼•ç®—æ³•ï¼Œé€‚åˆç”Ÿäº§ç¯å¢ƒçš„å¤§è§„æ¨¡å‘é‡æ£€ç´¢ã€‚</p><h3 id="å®‰è£…-2" tabindex="-1">å®‰è£… <a class="header-anchor" href="#å®‰è£…-2" aria-label="Permalink to â€œå®‰è£…â€">â€‹</a></h3><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pip</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pymilvus</span></span></code></pre></div><blockquote><p><strong>æ³¨æ„</strong>ï¼šä½¿ç”¨ Milvus éœ€è¦å…ˆå¯åŠ¨ Milvus æœåŠ¡ã€‚å¯ä»¥ä½¿ç”¨ Docker å¿«é€Ÿå¯åŠ¨ï¼š</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --name</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> milvus-standalone</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 19530:19530</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> milvusdb/milvus:latest</span></span></code></pre></div></blockquote><h3 id="æ”¯æŒçš„ç´¢å¼•ç±»å‹-1" tabindex="-1">æ”¯æŒçš„ç´¢å¼•ç±»å‹ <a class="header-anchor" href="#æ”¯æŒçš„ç´¢å¼•ç±»å‹-1" aria-label="Permalink to â€œæ”¯æŒçš„ç´¢å¼•ç±»å‹â€">â€‹</a></h3><table tabindex="0"><thead><tr><th>ç´¢å¼•ç±»å‹</th><th>è¯´æ˜</th><th>é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td><code>FLAT</code></td><td>æš´åŠ›æœç´¢</td><td>å°è§„æ¨¡æ•°æ®ï¼Œç²¾ç¡®ç»“æœ</td></tr><tr><td><code>HNSW</code></td><td>åŸºäºå›¾çš„ç´¢å¼•</td><td>ä¸­ç­‰è§„æ¨¡ï¼Œé«˜å¬å›ç‡</td></tr><tr><td><code>IVF_FLAT</code></td><td>å€’æ’ç´¢å¼•</td><td>å¤§è§„æ¨¡æ•°æ®</td></tr></tbody></table><h3 id="å‚æ•°è¯´æ˜-2" tabindex="-1">å‚æ•°è¯´æ˜ <a class="header-anchor" href="#å‚æ•°è¯´æ˜-2" aria-label="Permalink to â€œå‚æ•°è¯´æ˜â€">â€‹</a></h3><h4 id="flat-ç´¢å¼•-1" tabindex="-1">FLAT ç´¢å¼• <a class="header-anchor" href="#flat-ç´¢å¼•-1" aria-label="Permalink to â€œFLAT ç´¢å¼•â€">â€‹</a></h4><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">builder </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> builder_factory(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;milvus&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    d</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">64</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,                    </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># å‘é‡ç»´åº¦ï¼ˆå¿…éœ€ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    index_type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;FLAT&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    metric</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;L2&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,             </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># è·ç¦»åº¦é‡</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><table tabindex="0"><thead><tr><th>å‚æ•°</th><th>ç±»å‹</th><th>é»˜è®¤å€¼</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>d</code></td><td><code>int</code></td><td>å¿…éœ€</td><td>å‘é‡ç»´åº¦</td></tr><tr><td><code>metric</code></td><td><code>str</code></td><td><code>&quot;L2&quot;</code></td><td>è·ç¦»åº¦é‡ï¼š<code>&quot;L2&quot;</code>ã€<code>&quot;IP&quot;</code>ã€<code>&quot;COSINE&quot;</code></td></tr></tbody></table><h4 id="hnsw-ç´¢å¼•-1" tabindex="-1">HNSW ç´¢å¼• <a class="header-anchor" href="#hnsw-ç´¢å¼•-1" aria-label="Permalink to â€œHNSW ç´¢å¼•â€">â€‹</a></h4><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">builder </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> builder_factory(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;milvus&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    d</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">64</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    index_type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;HNSW&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    metric</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;COSINE&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    m</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">16</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,                    </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># æ¯ä¸ªèŠ‚ç‚¹çš„æœ€å¤§é‚»å±…æ•°</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    ef</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">50</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,                   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># æœç´¢æ—¶çš„å€™é€‰èŠ‚ç‚¹æ•°</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><table tabindex="0"><thead><tr><th>å‚æ•°</th><th>ç±»å‹</th><th>é»˜è®¤å€¼</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>m</code></td><td><code>int</code></td><td><code>16</code></td><td>æ¯ä¸ªèŠ‚ç‚¹çš„æœ€å¤§é‚»å±…æ•°</td></tr><tr><td><code>ef</code></td><td><code>int</code></td><td><code>None</code></td><td>æœç´¢æ—¶çš„å€™é€‰èŠ‚ç‚¹æ•°</td></tr></tbody></table><h4 id="ivf-flat-ç´¢å¼•" tabindex="-1">IVF_FLAT ç´¢å¼• <a class="header-anchor" href="#ivf-flat-ç´¢å¼•" aria-label="Permalink to â€œIVF_FLAT ç´¢å¼•â€">â€‹</a></h4><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">builder </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> builder_factory(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;milvus&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    d</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">64</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    index_type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;IVF_FLAT&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    metric</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;IP&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    nlist</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">128</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,               </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># èšç±»ä¸­å¿ƒæ•°é‡</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    nprobe</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">16</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,               </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># æœç´¢æ—¶è®¿é—®çš„èšç±»æ•°</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><table tabindex="0"><thead><tr><th>å‚æ•°</th><th>ç±»å‹</th><th>é»˜è®¤å€¼</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>nlist</code></td><td><code>int</code></td><td><code>128</code></td><td>èšç±»ä¸­å¿ƒæ•°é‡</td></tr><tr><td><code>nprobe</code></td><td><code>int</code></td><td><code>None</code></td><td>æœç´¢æ—¶è®¿é—®çš„èšç±»æ•°</td></tr></tbody></table><h3 id="ä½¿ç”¨ç¤ºä¾‹-2" tabindex="-1">ä½¿ç”¨ç¤ºä¾‹ <a class="header-anchor" href="#ä½¿ç”¨ç¤ºä¾‹-2" aria-label="Permalink to â€œä½¿ç”¨ç¤ºä¾‹â€">â€‹</a></h3><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch_rechub.serving </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> builder_factory</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">item_embeddings </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch.randn(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">64</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">dtype</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">torch.float32)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">user_embeddings </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch.randn(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">64</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">dtype</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">torch.float32)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ä½¿ç”¨ Milvus HNSW ç´¢å¼•</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">builder </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> builder_factory(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;milvus&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    d</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">64</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    index_type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;HNSW&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    metric</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;COSINE&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    m</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    ef</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">64</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">with</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> builder.from_embeddings(item_embeddings) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> indexer:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ids, distances </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> indexer.query(user_embeddings, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">top_k</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # æ³¨æ„ï¼šMilvus ç´¢å¼•ä¿å­˜åœ¨æœåŠ¡ç«¯ï¼Œä¸æ”¯æŒæœ¬åœ° save</span></span></code></pre></div><hr><h2 id="å®Œæ•´ç¤ºä¾‹-å¬å›æ¨¡å‹è¯„ä¼°" tabindex="-1">å®Œæ•´ç¤ºä¾‹ï¼šå¬å›æ¨¡å‹è¯„ä¼° <a class="header-anchor" href="#å®Œæ•´ç¤ºä¾‹-å¬å›æ¨¡å‹è¯„ä¼°" aria-label="Permalink to â€œå®Œæ•´ç¤ºä¾‹ï¼šå¬å›æ¨¡å‹è¯„ä¼°â€">â€‹</a></h2><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªå®Œæ•´çš„åŒå¡”æ¨¡å‹å‘é‡åŒ–è¯„ä¼°ç¤ºä¾‹ï¼š</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> collections</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> numpy </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> np</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pandas </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pd</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch_rechub.serving </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> builder_factory</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch_rechub.basic.metric </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> topk_metrics</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> match_evaluation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    user_embedding: torch.Tensor,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    item_embedding: torch.Tensor,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    test_user: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">dict</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    all_item: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">dict</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    user_col: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;user_id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    item_col: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;item_id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    raw_id_maps: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;./raw_id_maps.npy&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    topk: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">int</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    backend: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;faiss&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    **</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">backend_kwargs,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">):</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    ä½¿ç”¨å‘é‡æ£€ç´¢è¿›è¡Œå¬å›è¯„ä¼°</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    </span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    Args:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        user_embedding: ç”¨æˆ·åµŒå…¥å‘é‡ (n_users, dim)</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        item_embedding: ç‰©å“åµŒå…¥å‘é‡ (n_items, dim)</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        test_user: æµ‹è¯•ç”¨æˆ·æ•°æ®å­—å…¸</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        all_item: å…¨é‡ç‰©å“æ•°æ®å­—å…¸</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        user_col: ç”¨æˆ·IDåˆ—å</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        item_col: ç‰©å“IDåˆ—å</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        raw_id_maps: IDæ˜ å°„æ–‡ä»¶è·¯å¾„</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        topk: å¬å›æ•°é‡</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        backend: æ£€ç´¢åç«¯ (&quot;annoy&quot;, &quot;faiss&quot;, &quot;milvus&quot;)</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        **backend_kwargs: ä¼ é€’ç»™ builder_factory çš„é¢å¤–å‚æ•°</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    </span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    Returns:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        è¯„ä¼°æŒ‡æ ‡å­—å…¸</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ä½¿ç”¨ </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">backend</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> è¿›è¡Œå‘é‡åŒ–å¬å›è¯„ä¼°&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 1. åˆ›å»º Builder</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    dim </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> item_embedding.shape[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> backend </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;annoy&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        builder </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> builder_factory(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;annoy&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">d</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">dim, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">n_trees</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">backend_kwargs)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    elif</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> backend </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;faiss&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        builder </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> builder_factory(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;faiss&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">index_type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Flat&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">metric</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;L2&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">backend_kwargs)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    elif</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> backend </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;milvus&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        builder </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> builder_factory(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;milvus&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">d</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">dim, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">index_type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;FLAT&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">metric</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;L2&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">backend_kwargs)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        raise</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ValueError</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ä¸æ”¯æŒçš„åç«¯: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">backend</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 2. ç¡®ä¿å¼ é‡åœ¨ CPU ä¸Š</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    item_embedding </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> item_embedding.cpu().float()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    user_embedding </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user_embedding.cpu().float()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 3. åŠ è½½ ID æ˜ å°„</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    user_map, item_map </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> np.load(raw_id_maps, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">allow_pickle</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">True</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 4. æ„å»ºç´¢å¼•å¹¶æŸ¥è¯¢</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    match_res </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> collections.defaultdict(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">dict</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    with</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> builder.from_embeddings(item_embedding) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> indexer:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ids, distances </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> indexer.query(user_embedding, topk)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ids_np </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ids.numpy()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i, user_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> enumerate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(test_user[user_col]):</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            items_idx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ids_np[i]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            predicted_item_ids </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> all_item[item_col][items_idx]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            match_res[user_map[user_id]] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> np.vectorize(item_map.get)(predicted_item_ids)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 5. æ„å»º ground truth</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    data </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pd.DataFrame({user_col: test_user[user_col], item_col: test_user[item_col]})</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    data[user_col] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data[user_col].map(user_map)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    data[item_col] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data[item_col].map(item_map)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    user_pos_item </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data.groupby(user_col).agg(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">list</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).reset_index()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ground_truth </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> dict</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">zip</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(user_pos_item[user_col], user_pos_item[item_col]))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 6. è®¡ç®—æŒ‡æ ‡</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    out </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> topk_metrics(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">y_true</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ground_truth, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">y_pred</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">match_res, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">topKs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[topk])</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> out</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ä½¿ç”¨ç¤ºä¾‹</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># result = match_evaluation(</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#     user_embedding, item_embedding, test_user, all_item,</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#     topk=10, backend=&quot;faiss&quot;, index_type=&quot;HNSW&quot;, m=32</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># )</span></span></code></pre></div><hr><h2 id="æ€§èƒ½å¯¹æ¯”ä¸é€‰å‹å»ºè®®" tabindex="-1">æ€§èƒ½å¯¹æ¯”ä¸é€‰å‹å»ºè®® <a class="header-anchor" href="#æ€§èƒ½å¯¹æ¯”ä¸é€‰å‹å»ºè®®" aria-label="Permalink to â€œæ€§èƒ½å¯¹æ¯”ä¸é€‰å‹å»ºè®®â€">â€‹</a></h2><table tabindex="0"><thead><tr><th>ç‰¹æ€§</th><th>Annoy</th><th>FAISS</th><th>Milvus</th></tr></thead><tbody><tr><td><strong>å®‰è£…éš¾åº¦</strong></td><td>ç®€å•</td><td>ä¸­ç­‰</td><td>éœ€è¦æœåŠ¡</td></tr><tr><td><strong>å†…å­˜å ç”¨</strong></td><td>ä½</td><td>ä¸­ç­‰</td><td>ä¾èµ–æœåŠ¡é…ç½®</td></tr><tr><td><strong>æ„å»ºé€Ÿåº¦</strong></td><td>æ…¢</td><td>å¿«</td><td>å¿«</td></tr><tr><td><strong>æŸ¥è¯¢é€Ÿåº¦</strong></td><td>ä¸­ç­‰</td><td>å¿«</td><td>å¿«</td></tr><tr><td><strong>GPU æ”¯æŒ</strong></td><td>âŒ</td><td>âœ…</td><td>âœ…</td></tr><tr><td><strong>åˆ†å¸ƒå¼</strong></td><td>âŒ</td><td>âŒ</td><td>âœ…</td></tr><tr><td><strong>é€‚ç”¨åœºæ™¯</strong></td><td>å°è§„æ¨¡ç¦»çº¿</td><td>ä¸­å¤§è§„æ¨¡</td><td>ç”Ÿäº§ç¯å¢ƒ</td></tr></tbody></table><h3 id="é€‰å‹å»ºè®®" tabindex="-1">é€‰å‹å»ºè®® <a class="header-anchor" href="#é€‰å‹å»ºè®®" aria-label="Permalink to â€œé€‰å‹å»ºè®®â€">â€‹</a></h3><ul><li><strong>å¿«é€ŸåŸå‹/å°æ•°æ®é›†</strong>ï¼šä½¿ç”¨ <strong>Annoy</strong>ï¼Œå®‰è£…ç®€å•ï¼Œå†…å­˜å‹å¥½</li><li><strong>ä¸­å¤§è§„æ¨¡ç¦»çº¿è®¡ç®—</strong>ï¼šä½¿ç”¨ <strong>FAISS</strong>ï¼Œæ€§èƒ½ä¼˜ç§€ï¼Œæ”¯æŒ GPU</li><li><strong>ç”Ÿäº§ç¯å¢ƒ/åœ¨çº¿æœåŠ¡</strong>ï¼šä½¿ç”¨ <strong>Milvus</strong>ï¼Œæ”¯æŒåˆ†å¸ƒå¼å’ŒåŠ¨æ€æ›´æ–°</li></ul><hr><h2 id="api-å‚è€ƒ" tabindex="-1">API å‚è€ƒ <a class="header-anchor" href="#api-å‚è€ƒ" aria-label="Permalink to â€œAPI å‚è€ƒâ€">â€‹</a></h2><h3 id="basebuilder" tabindex="-1">BaseBuilder <a class="header-anchor" href="#basebuilder" aria-label="Permalink to â€œBaseBuilderâ€">â€‹</a></h3><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BaseBuilder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">abc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ABC</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">):</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> from_embeddings</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(self, embeddings: torch.Tensor) -&gt; ContextManager[BaseIndexer]:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;&quot;&quot;ä»åµŒå…¥å‘é‡æ„å»ºç´¢å¼•&quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> from_index_file</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(self, index_file: FilePath) -&gt; ContextManager[BaseIndexer]:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;&quot;&quot;ä»æ–‡ä»¶åŠ è½½ç´¢å¼•&quot;&quot;&quot;</span></span></code></pre></div><h3 id="baseindexer" tabindex="-1">BaseIndexer <a class="header-anchor" href="#baseindexer" aria-label="Permalink to â€œBaseIndexerâ€">â€‹</a></h3><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BaseIndexer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">abc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ABC</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">):</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(self, embeddings: torch.Tensor, top_k: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) -&gt; tuple[torch.Tensor, torch.Tensor]:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        æŸ¥è¯¢æœ€è¿‘é‚»</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        </span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        Args:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">            embeddings: æŸ¥è¯¢å‘é‡ (n, d)</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">            top_k: è¿”å›çš„æœ€è¿‘é‚»æ•°é‡</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">            </span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        Returns:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">            ids: æœ€è¿‘é‚»ID (n, top_k)</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">            distances: è·ç¦» (n, top_k)</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> save</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(self, file_path: FilePath) -&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">None</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;&quot;&quot;ä¿å­˜ç´¢å¼•åˆ°æ–‡ä»¶&quot;&quot;&quot;</span></span></code></pre></div></div></div></main><footer class="VPDocFooter" data-v-7011f0d8 data-v-e257564d><!--[--><!--]--><!----><nav class="prev-next" aria-labelledby="doc-footer-aria-label" data-v-e257564d><span class="visually-hidden" id="doc-footer-aria-label" data-v-e257564d>Pager</span><div class="pager" data-v-e257564d><a class="VPLink link pager-link prev" href="/torch-rechub/zh/serving/onnx.html" data-v-e257564d><!--[--><span class="desc" data-v-e257564d>Previous page</span><span class="title" data-v-e257564d>ONNX å¯¼å‡ºä¸é‡åŒ–</span><!--]--></a></div><div class="pager" data-v-e257564d><a class="VPLink link pager-link next" href="/torch-rechub/zh/serving/demo.html" data-v-e257564d><!--[--><span class="desc" data-v-e257564d>Next page</span><span class="title" data-v-e257564d>åœ¨çº¿æœåŠ¡ç¤ºä¾‹</span><!--]--></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"api_api.md\":\"A-66VmfZ\",\"blog_hllm_reproduction.md\":\"DGw_QFLA\",\"blog_match.md\":\"Dbmtv65x\",\"blog_rank.md\":\"4pCJlY24\",\"cache_api-basic.md\":\"CGpgfakv\",\"cache_api-models.md\":\"CKqTe4Cr\",\"cache_api-trainers.md\":\"l7Op-0s4\",\"cache_api-utils.md\":\"qEvm8nX8\",\"cache_hllm_reproduction.md\":\"SEr1WJjZ\",\"cache_hstu_reproduction.md\":\"Cuqmg-9V\",\"cache_match.md\":\"oRxGdwG1\",\"cache_rank.md\":\"BVMLR97X\",\"cache_å‚è€ƒèµ„æ–™.md\":\"BB8mAuQu\",\"community_changelog.md\":\"DLOc-n-J\",\"community_contributing.md\":\"C4ci_jwy\",\"community_faq.md\":\"CCT-0g7P\",\"contributing.md\":\"B60gEQPy\",\"core_data.md\":\"DhiUH6f5\",\"core_evaluation.md\":\"Tcbby-zM\",\"core_features.md\":\"lJx9Atbz\",\"core_intro.md\":\"BSZDmg9L\",\"guide_install.md\":\"0RXmcXSE\",\"guide_intro.md\":\"B6thu5MX\",\"guide_quick_start.md\":\"fYGiQras\",\"index.md\":\"D6BLudcp\",\"manual_api-reference_basic.md\":\"gix_oEYU\",\"manual_api-reference_models.md\":\"BCvabpY5\",\"manual_api-reference_trainers.md\":\"DeV8vyN9\",\"manual_api-reference_utils.md\":\"ljAtlnqQ\",\"manual_faq.md\":\"D9qYkPgc\",\"manual_getting-started.md\":\"CH5XD2SI\",\"manual_installation.md\":\"DLg97S38\",\"manual_tutorials_matching.md\":\"Cj8L2Pxw\",\"manual_tutorials_multi-task.md\":\"DZddiWQE\",\"manual_tutorials_ranking.md\":\"DHMQ6T31\",\"models_generative.md\":\"1stfvmLT\",\"models_intro.md\":\"LruBZ3sW\",\"models_matching.md\":\"CZBP8Phs\",\"models_mtl.md\":\"6jrw2AaX\",\"models_ranking.md\":\"v_X3EvGe\",\"serving_demo.md\":\"Dq1JJMmt\",\"serving_intro.md\":\"lcN1Q8P_\",\"serving_onnx.md\":\"DXHmi9Si\",\"serving_vector_index.md\":\"Bs2N5WRk\",\"tools_callbacks.md\":\"Do70NaKe\",\"tools_intro.md\":\"BHyMM0TD\",\"tools_tracking.md\":\"CeqDASrd\",\"tools_visualization.md\":\"CMTJakOm\",\"tutorials_ctr.md\":\"CbvshbXm\",\"tutorials_intro.md\":\"DH0K3XVg\",\"tutorials_pipeline.md\":\"D4twMYII\",\"tutorials_retrieval.md\":\"C-rR3Ycv\",\"zh_api_api.md\":\"BohBm0dc\",\"zh_community_changelog.md\":\"Ck_QzDnY\",\"zh_community_contributing.md\":\"p7WeO_SG\",\"zh_community_faq.md\":\"Cdh5kAyr\",\"zh_core_data.md\":\"BmatsmtN\",\"zh_core_evaluation.md\":\"CZ4IY6QN\",\"zh_core_features.md\":\"B3KtgG8c\",\"zh_core_intro.md\":\"CyK4J-gM\",\"zh_guide_install.md\":\"abSbe_hT\",\"zh_guide_intro.md\":\"DUCqvu9j\",\"zh_guide_quick_start.md\":\"CGotv9k1\",\"zh_index.md\":\"FzYY5Fp0\",\"zh_models_generative.md\":\"hl6-S9dV\",\"zh_models_intro.md\":\"qkawg5eg\",\"zh_models_matching.md\":\"CPckUxBI\",\"zh_models_mtl.md\":\"0PMEngFJ\",\"zh_models_ranking.md\":\"DbG-iAX4\",\"zh_serving_demo.md\":\"D96OcQc_\",\"zh_serving_intro.md\":\"C1684zAa\",\"zh_serving_onnx.md\":\"M5gufXv2\",\"zh_serving_vector_index.md\":\"B2v0WA5L\",\"zh_tools_callbacks.md\":\"CuCLKBNf\",\"zh_tools_intro.md\":\"C6LOFaB9\",\"zh_tools_tracking.md\":\"DWCuTSo7\",\"zh_tools_visualization.md\":\"OlgOg9Ly\",\"zh_tutorials_ctr.md\":\"CNQA_2vC\",\"zh_tutorials_intro.md\":\"CfGQ1akf\",\"zh_tutorials_pipeline.md\":\"BxD5vxil\",\"zh_tutorials_retrieval.md\":\"BhFWK1kx\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"torch-rechub\",\"description\":\"A Lighting Pytorch Framework for Recommendation Models, Easy-to-use and Easy-to-extend.\",\"base\":\"/torch-rechub/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"logo\":\"/img/logo.png\",\"search\":{\"provider\":\"local\"},\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/datawhalechina/torch-rechub\"}]},\"locales\":{\"root\":{\"label\":\"English\",\"lang\":\"en\",\"themeConfig\":{\"nav\":[{\"text\":\"ğŸ  Home\",\"link\":\"/\"},{\"text\":\"ğŸš€ Getting Started\",\"link\":\"/guide/intro\"},{\"text\":\"âš™ï¸ Core\",\"link\":\"/core/intro\"},{\"text\":\"ğŸ° Models\",\"link\":\"/models/intro\"},{\"text\":\"ğŸ› ï¸ Tools\",\"link\":\"/tools/intro\"},{\"text\":\"ğŸš€ Serving\",\"link\":\"/serving/intro\"},{\"text\":\"ğŸ“– Tutorials\",\"link\":\"/tutorials/intro\"},{\"text\":\"â„¹ï¸ API\",\"link\":\"/api/api\"},{\"text\":\"ğŸ‘¥ Community\",\"link\":\"/community/faq\"}],\"sidebar\":{\"/guide/\":[{\"text\":\"ğŸš€ Getting Started\",\"items\":[{\"text\":\"Overview\",\"link\":\"/guide/intro\"},{\"text\":\"Installation\",\"link\":\"/guide/install\"},{\"text\":\"Quick Start\",\"link\":\"/guide/quick_start\"}]}],\"/core/\":[{\"text\":\"âš™ï¸ Core Components\",\"items\":[{\"text\":\"Overview\",\"link\":\"/core/intro\"},{\"text\":\"Feature Columns\",\"link\":\"/core/features\"},{\"text\":\"Data Pipeline\",\"link\":\"/core/data\"},{\"text\":\"Training & Eval\",\"link\":\"/core/evaluation\"}]}],\"/models/\":[{\"text\":\"ğŸ° Model Zoo\",\"items\":[{\"text\":\"Overview\",\"link\":\"/models/intro\"},{\"text\":\"Ranking Models\",\"link\":\"/models/ranking\"},{\"text\":\"Matching Models\",\"link\":\"/models/matching\"},{\"text\":\"Multi-Task Models\",\"link\":\"/models/mtl\"},{\"text\":\"Generative Models\",\"link\":\"/models/generative\"}]}],\"/tools/\":[{\"text\":\"ğŸ› ï¸ Dev Tools\",\"items\":[{\"text\":\"Overview\",\"link\":\"/tools/intro\"},{\"text\":\"Visualization\",\"link\":\"/tools/visualization\"},{\"text\":\"Experiment Tracking\",\"link\":\"/tools/tracking\"},{\"text\":\"Callbacks\",\"link\":\"/tools/callbacks\"}]}],\"/serving/\":[{\"text\":\"ğŸš€ Serving\",\"items\":[{\"text\":\"Overview\",\"link\":\"/serving/intro\"},{\"text\":\"ONNX & Quantization\",\"link\":\"/serving/onnx\"},{\"text\":\"Vector Indexing\",\"link\":\"/serving/vector_index\"},{\"text\":\"Serving Demo\",\"link\":\"/serving/demo\"}]}],\"/tutorials/\":[{\"text\":\"ğŸ“– Tutorials\",\"items\":[{\"text\":\"Overview\",\"link\":\"/tutorials/intro\"},{\"text\":\"CTR Pipeline\",\"link\":\"/tutorials/ctr\"},{\"text\":\"Retrieval System\",\"link\":\"/tutorials/retrieval\"},{\"text\":\"Big Data Pipeline\",\"link\":\"/tutorials/pipeline\"}]}],\"/api/\":[{\"text\":\"â„¹ï¸ API Reference\",\"items\":[{\"text\":\"Main API\",\"link\":\"/api/api\"}]}],\"/community/\":[{\"text\":\"ğŸ“˜ Community\",\"items\":[{\"text\":\"FAQ\",\"link\":\"/community/faq\"},{\"text\":\"Contributing\",\"link\":\"/community/contributing\"},{\"text\":\"Changelog\",\"link\":\"/community/changelog\"}]}]}}},\"zh\":{\"label\":\"ä¸­æ–‡\",\"lang\":\"zh-CN\",\"link\":\"/zh/\",\"themeConfig\":{\"nav\":[{\"text\":\"ğŸ  é¦–é¡µ\",\"link\":\"/zh/\"},{\"text\":\"ğŸš€ å¿«é€Ÿå…¥é—¨\",\"link\":\"/zh/guide/intro\"},{\"text\":\"âš™ï¸ æ ¸å¿ƒç»„ä»¶\",\"link\":\"/zh/core/intro\"},{\"text\":\"ğŸ° æ¨¡å‹åº“\",\"link\":\"/zh/models/intro\"},{\"text\":\"ğŸ› ï¸ ç ”å‘å·¥å…·\",\"link\":\"/zh/tools/intro\"},{\"text\":\"ğŸš€ ç”Ÿäº§éƒ¨ç½²\",\"link\":\"/zh/serving/intro\"},{\"text\":\"ğŸ“– åœºæ™¯æ•™ç¨‹\",\"link\":\"/zh/tutorials/intro\"},{\"text\":\"â„¹ï¸ API\",\"link\":\"/zh/api/api\"},{\"text\":\"ğŸ‘¥ ç¤¾åŒº\",\"link\":\"/zh/community/faq\"}],\"sidebar\":{\"/zh/guide/\":[{\"text\":\"ğŸš€ å¿«é€Ÿå…¥é—¨\",\"items\":[{\"text\":\"å¯¼è§ˆ (Overview)\",\"link\":\"/zh/guide/intro\"},{\"text\":\"å®‰è£…æŒ‡å—\",\"link\":\"/zh/guide/install\"},{\"text\":\"3åˆ†é’Ÿä¸Šæ‰‹\",\"link\":\"/zh/guide/quick_start\"}]}],\"/zh/core/\":[{\"text\":\"âš™ï¸ æ ¸å¿ƒç»„ä»¶\",\"items\":[{\"text\":\"å¯¼è§ˆ (Overview)\",\"link\":\"/zh/core/intro\"},{\"text\":\"ç‰¹å¾å®šä¹‰ (Features)\",\"link\":\"/zh/core/features\"},{\"text\":\"æ•°æ®æµæ°´çº¿ (Data)\",\"link\":\"/zh/core/data\"},{\"text\":\"è®­ç»ƒä¸è¯„ä¼° (Eval)\",\"link\":\"/zh/core/evaluation\"}]}],\"/zh/models/\":[{\"text\":\"ğŸ° æ¨¡å‹åº“\",\"items\":[{\"text\":\"å¯¼è§ˆ (Overview)\",\"link\":\"/zh/models/intro\"},{\"text\":\"æ’åºæ¨¡å‹ (Ranking)\",\"link\":\"/zh/models/ranking\"},{\"text\":\"å¬å›æ¨¡å‹ (Matching)\",\"link\":\"/zh/models/matching\"},{\"text\":\"å¤šä»»åŠ¡æ¨¡å‹ (MTL)\",\"link\":\"/zh/models/mtl\"},{\"text\":\"ç”Ÿæˆå¼æ¨¡å‹ (Generative)\",\"link\":\"/zh/models/generative\"}]}],\"/zh/tools/\":[{\"text\":\"ğŸ› ï¸ ç ”å‘å·¥å…·\",\"items\":[{\"text\":\"å¯¼è§ˆ (Overview)\",\"link\":\"/zh/tools/intro\"},{\"text\":\"å¯è§†åŒ–ç›‘æ§\",\"link\":\"/zh/tools/visualization\"},{\"text\":\"å®éªŒè¿½è¸ª\",\"link\":\"/zh/tools/tracking\"},{\"text\":\"å›è°ƒå‡½æ•°\",\"link\":\"/zh/tools/callbacks\"}]}],\"/zh/serving/\":[{\"text\":\"ğŸš€ ç”Ÿäº§éƒ¨ç½²\",\"items\":[{\"text\":\"å¯¼è§ˆ (Overview)\",\"link\":\"/zh/serving/intro\"},{\"text\":\"ONNX å¯¼å‡ºä¸é‡åŒ–\",\"link\":\"/zh/serving/onnx\"},{\"text\":\"å‘é‡æ£€ç´¢å°è£…\",\"link\":\"/zh/serving/vector_index\"},{\"text\":\"åœ¨çº¿æœåŠ¡ç¤ºä¾‹\",\"link\":\"/zh/serving/demo\"}]}],\"/zh/tutorials/\":[{\"text\":\"ğŸ“– åœºæ™¯æ•™ç¨‹\",\"items\":[{\"text\":\"å¯¼è§ˆ (Overview)\",\"link\":\"/zh/tutorials/intro\"},{\"text\":\"CTR é¢„ä¼°æµç¨‹\",\"link\":\"/zh/tutorials/ctr\"},{\"text\":\"å¬å›ç³»ç»Ÿæ­å»º\",\"link\":\"/zh/tutorials/retrieval\"},{\"text\":\"å…¨é“¾è·¯æµæ°´çº¿\",\"link\":\"/zh/tutorials/pipeline\"}]}],\"/zh/api/\":[{\"text\":\"â„¹ï¸ API Reference\",\"items\":[{\"text\":\"API å‚è€ƒ\",\"link\":\"/zh/api/api\"}]}],\"/zh/community/\":[{\"text\":\"ğŸ“˜ ç¤¾åŒºä¿¡æ¯\",\"items\":[{\"text\":\"å¸¸è§é—®é¢˜ (FAQ)\",\"link\":\"/zh/community/faq\"},{\"text\":\"è´¡çŒ®æŒ‡å— (Contributing)\",\"link\":\"/zh/community/contributing\"},{\"text\":\"ç‰ˆæœ¬æ—¥å¿— (Changelog)\",\"link\":\"/zh/community/changelog\"}]}]}}}},\"scrollOffset\":134,\"cleanUrls\":false,\"additionalConfig\":{}}");</script>
    
  </body>
</html>