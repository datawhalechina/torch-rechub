<!DOCTYPE html>
<html lang="zh-CN" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>DSSM ä½¿ç”¨ç¤ºä¾‹ | torch-rechub</title>
    <meta name="description" content="DSSM åŒå¡”æ¨¡å‹å®Œæ•´ä½¿ç”¨æ•™ç¨‹ â€”â€” ä»æ•°æ®å‡†å¤‡åˆ°å‘é‡å¬å›">
    <meta name="generator" content="VitePress v2.0.0-alpha.15">
    <link rel="preload stylesheet" href="/torch-rechub/assets/style.Dnbe36Wi.css" as="style">
    <link rel="preload stylesheet" href="/torch-rechub/vp-icons.css" as="style">
    
    <script type="module" src="/torch-rechub/assets/app.CfwSSSUe.js"></script>
    <link rel="preload" href="/torch-rechub/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/torch-rechub/assets/chunks/theme.7YUiIYKr.js">
    <link rel="modulepreload" href="/torch-rechub/assets/chunks/framework.BMaBgWHN.js">
    <link rel="modulepreload" href="/torch-rechub/assets/zh_tutorials_models_matching_dssm.md.DHb23E4X.lean.js">
    <link rel="icon" href="/torch-rechub/favicon.ico">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-1df9f90f><!--[--><!--]--><!--[--><span tabindex="-1" data-v-331ec75c></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-331ec75c>Skip to content</a><!--]--><!----><header class="VPNav" data-v-1df9f90f data-v-da52a441><div class="VPNavBar" data-v-da52a441 data-v-70946a35><div class="wrapper" data-v-70946a35><div class="container" data-v-70946a35><div class="title" data-v-70946a35><div class="VPNavBarTitle has-sidebar" data-v-70946a35 data-v-1e38c6bc><a class="title" href="/torch-rechub/zh/" data-v-1e38c6bc><!--[--><!--]--><!--[--><img class="VPImage logo" src="/torch-rechub/img/logo.png" alt data-v-8426fc1a><!--]--><span data-v-1e38c6bc>torch-rechub</span><!--[--><!--]--></a></div></div><div class="content" data-v-70946a35><div class="content-body" data-v-70946a35><!--[--><!--]--><div class="VPNavBarSearch search" data-v-70946a35><!--[--><!----><div id="local-search"><button type="button" aria-label="Search" aria-keyshortcuts="/ control+k meta+k" class="DocSearch DocSearch-Button"><span class="DocSearch-Button-Container"><span class="vpi-search DocSearch-Search-Icon"></span><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key"></kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-70946a35 data-v-39714824><span id="main-nav-aria-label" class="visually-hidden" data-v-39714824> Main Navigation </span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/torch-rechub/zh/" tabindex="0" data-v-39714824 data-v-52a1d768><!--[--><span data-v-52a1d768>ğŸ  é¦–é¡µ</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/torch-rechub/zh/guide/intro.html" tabindex="0" data-v-39714824 data-v-52a1d768><!--[--><span data-v-52a1d768>ğŸš€ å¿«é€Ÿå…¥é—¨</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/torch-rechub/zh/core/intro.html" tabindex="0" data-v-39714824 data-v-52a1d768><!--[--><span data-v-52a1d768>âš™ï¸ æ ¸å¿ƒç»„ä»¶</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/torch-rechub/zh/models/intro.html" tabindex="0" data-v-39714824 data-v-52a1d768><!--[--><span data-v-52a1d768>ğŸ° æ¨¡å‹åº“</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/torch-rechub/zh/tools/intro.html" tabindex="0" data-v-39714824 data-v-52a1d768><!--[--><span data-v-52a1d768>ğŸ› ï¸ ç ”å‘å·¥å…·</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/torch-rechub/zh/serving/intro.html" tabindex="0" data-v-39714824 data-v-52a1d768><!--[--><span data-v-52a1d768>ğŸš€ ç”Ÿäº§éƒ¨ç½²</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/torch-rechub/zh/tutorials/intro.html" tabindex="0" data-v-39714824 data-v-52a1d768><!--[--><span data-v-52a1d768>ğŸ“– åœºæ™¯æ•™ç¨‹</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/torch-rechub/zh/api/api.html" tabindex="0" data-v-39714824 data-v-52a1d768><!--[--><span data-v-52a1d768>â„¹ï¸ API</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/torch-rechub/zh/community/faq.html" tabindex="0" data-v-39714824 data-v-52a1d768><!--[--><span data-v-52a1d768>ğŸ‘¥ ç¤¾åŒº</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/torch-rechub/zh/blog/match.html" tabindex="0" data-v-39714824 data-v-52a1d768><!--[--><span data-v-52a1d768>ğŸ“ åšå®¢</span><!--]--></a><!--]--><!--]--></nav><div class="VPFlyout VPNavBarTranslations translations" data-v-70946a35 data-v-4c1766e2 data-v-42cb505d><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="Change language" data-v-42cb505d><span class="text" data-v-42cb505d><span class="vpi-languages option-icon" data-v-42cb505d></span><!----><span class="vpi-chevron-down text-icon" data-v-42cb505d></span></span></button><div class="menu" data-v-42cb505d><div class="VPMenu" data-v-42cb505d data-v-25a6cce8><!----><!--[--><!--[--><div class="items" data-v-4c1766e2><p class="title" data-v-4c1766e2>ä¸­æ–‡</p><!--[--><div class="VPMenuLink" data-v-4c1766e2 data-v-faf5b206><a class="VPLink link" href="/torch-rechub/tutorials/models/matching/dssm.html" lang="en" data-v-faf5b206><!--[--><span data-v-faf5b206>English</span><!--]--></a></div><!--]--></div><!--]--><!--]--></div></div></div><div class="VPNavBarAppearance appearance" data-v-70946a35 data-v-6c893767><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-6c893767 data-v-5337faa4 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-5337faa4></span><span class="vpi-moon moon" data-v-5337faa4></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-70946a35 data-v-0394ad82 data-v-d07f11e6><!--[--><a class="VPSocialLink no-icon" href="https://github.com/datawhalechina/torch-rechub" aria-label="github" target="_blank" rel="me noopener" data-v-d07f11e6 data-v-591a6b30><span class="vpi-social-github"></span></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-70946a35 data-v-bf2fac68 data-v-42cb505d><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-42cb505d><span class="vpi-more-horizontal icon" data-v-42cb505d></span></button><div class="menu" data-v-42cb505d><div class="VPMenu" data-v-42cb505d data-v-25a6cce8><!----><!--[--><!--[--><div class="group translations" data-v-bf2fac68><p class="trans-title" data-v-bf2fac68>ä¸­æ–‡</p><!--[--><div class="VPMenuLink" data-v-bf2fac68 data-v-faf5b206><a class="VPLink link" href="/torch-rechub/tutorials/models/matching/dssm.html" lang="en" data-v-faf5b206><!--[--><span data-v-faf5b206>English</span><!--]--></a></div><!--]--></div><div class="group" data-v-bf2fac68><div class="item appearance" data-v-bf2fac68><p class="label" data-v-bf2fac68>Appearance</p><div class="appearance-action" data-v-bf2fac68><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-bf2fac68 data-v-5337faa4 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-5337faa4></span><span class="vpi-moon moon" data-v-5337faa4></span><!--]--></span></span></button></div></div></div><div class="group" data-v-bf2fac68><div class="item social-links" data-v-bf2fac68><div class="VPSocialLinks social-links-list" data-v-bf2fac68 data-v-d07f11e6><!--[--><a class="VPSocialLink no-icon" href="https://github.com/datawhalechina/torch-rechub" aria-label="github" target="_blank" rel="me noopener" data-v-d07f11e6 data-v-591a6b30><span class="vpi-social-github"></span></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-70946a35 data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div></div><div class="divider" data-v-70946a35><div class="divider-line" data-v-70946a35></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-1df9f90f data-v-db738f89><div class="container" data-v-db738f89><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-db738f89><span class="vpi-align-left menu-icon" data-v-db738f89></span><span class="menu-text" data-v-db738f89>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-db738f89 data-v-0bf0e06f><button data-v-0bf0e06f>Return to top</button><!----></div></div></div><aside class="VPSidebar" data-v-1df9f90f data-v-af661f50><div class="curtain" data-v-af661f50></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-af661f50><span class="visually-hidden" id="sidebar-aria-label" data-v-af661f50> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="no-transition group" data-v-8d50c081><section class="VPSidebarItem level-0" data-v-8d50c081 data-v-d81de50c><div class="item" role="button" tabindex="0" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><h2 class="text" data-v-d81de50c>ğŸ“– åœºæ™¯æ•™ç¨‹</h2><!----></div><div class="items" data-v-d81de50c><!--[--><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/torch-rechub/zh/tutorials/intro.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>å¯¼è§ˆ (Overview)</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/torch-rechub/zh/tutorials/ctr.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>CTR é¢„ä¼°æµç¨‹</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/torch-rechub/zh/tutorials/retrieval.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>å¬å›ç³»ç»Ÿæ­å»º</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/torch-rechub/zh/tutorials/pipeline.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>å…¨é“¾è·¯æµæ°´çº¿</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-1df9f90f data-v-c87f25bf><div class="VPDoc has-sidebar has-aside" data-v-c87f25bf data-v-7011f0d8><!--[--><!--]--><div class="container" data-v-7011f0d8><div class="aside" data-v-7011f0d8><div class="aside-curtain" data-v-7011f0d8></div><div class="aside-container" data-v-7011f0d8><div class="aside-content" data-v-7011f0d8><div class="VPDocAside" data-v-7011f0d8 data-v-3f215769><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-3f215769 data-v-60d5052e><div class="content" data-v-60d5052e><div class="outline-marker" data-v-60d5052e></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-60d5052e>On this page</div><ul class="VPDocOutlineItem root" data-v-60d5052e data-v-1ce71065><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-3f215769></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-7011f0d8><div class="content-container" data-v-7011f0d8><!--[--><!--]--><main class="main" data-v-7011f0d8><div style="position:relative;" class="vp-doc _torch-rechub_zh_tutorials_models_matching_dssm" data-v-7011f0d8><div><h1 id="dssm-ä½¿ç”¨ç¤ºä¾‹" tabindex="-1">DSSM ä½¿ç”¨ç¤ºä¾‹ <a class="header-anchor" href="#dssm-ä½¿ç”¨ç¤ºä¾‹" aria-label="Permalink to â€œDSSM ä½¿ç”¨ç¤ºä¾‹â€">â€‹</a></h1><h2 id="_1-æ¨¡å‹ç®€ä»‹ä¸é€‚ç”¨åœºæ™¯" tabindex="-1">1. æ¨¡å‹ç®€ä»‹ä¸é€‚ç”¨åœºæ™¯ <a class="header-anchor" href="#_1-æ¨¡å‹ç®€ä»‹ä¸é€‚ç”¨åœºæ™¯" aria-label="Permalink to â€œ1. æ¨¡å‹ç®€ä»‹ä¸é€‚ç”¨åœºæ™¯â€">â€‹</a></h2><p>DSSMï¼ˆDeep Structured Semantic Modelï¼‰æ˜¯å¾®è½¯åœ¨ CIKM&#39;2013 ä¸Šæå‡ºçš„ç»å…¸åŒå¡”æ¨¡å‹ï¼Œå°†ç”¨æˆ·å’Œç‰©å“åˆ†åˆ«é€šè¿‡å„è‡ªçš„ DNN Tower æ˜ å°„åˆ°åŒä¸€å‘é‡ç©ºé—´ï¼Œä½¿ç”¨ä½™å¼¦ç›¸ä¼¼åº¦è®¡ç®—åŒ¹é…åˆ†æ•°ã€‚æ˜¯æ¨èç³»ç»Ÿ<strong>å¬å›é˜¶æ®µ</strong>æœ€å¸¸ç”¨çš„åŸºç¡€æ¨¡å‹ã€‚</p><p><strong>è®ºæ–‡</strong>: <a href="https://posenhuang.github.io/papers/cikm2013_DSSM_fullversion.pdf" target="_blank" rel="noreferrer">Learning Deep Structured Semantic Models for Web Search using Clickthrough Data</a></p><h3 id="æ¨¡å‹ç»“æ„" tabindex="-1">æ¨¡å‹ç»“æ„ <a class="header-anchor" href="#æ¨¡å‹ç»“æ„" aria-label="Permalink to â€œæ¨¡å‹ç»“æ„â€">â€‹</a></h3><div align="center"><img src="/torch-rechub/img/models/dssm_arch.png" alt="DSSM Model Architecture" width="500"></div><ul><li><strong>User Tower</strong>ï¼šå°†ç”¨æˆ·ç‰¹å¾æ˜ å°„ä¸ºå‘é‡è¡¨ç¤º</li><li><strong>Item Tower</strong>ï¼šå°†ç‰©å“ç‰¹å¾æ˜ å°„ä¸ºå‘é‡è¡¨ç¤º</li><li><strong>ç›¸ä¼¼åº¦è®¡ç®—</strong>ï¼šé€šè¿‡ä½™å¼¦ç›¸ä¼¼åº¦ / ç‚¹ç§¯è®¡ç®— User-Item åŒ¹é…åˆ†</li></ul><h3 id="é€‚ç”¨åœºæ™¯" tabindex="-1">é€‚ç”¨åœºæ™¯ <a class="header-anchor" href="#é€‚ç”¨åœºæ™¯" aria-label="Permalink to â€œé€‚ç”¨åœºæ™¯â€">â€‹</a></h3><ul><li>æ¨èç³»ç»Ÿå¬å›é˜¶æ®µ</li><li>å¤§è§„æ¨¡å€™é€‰é›†å¿«é€Ÿç­›é€‰ï¼ˆå‘é‡æ£€ç´¢ï¼‰</li><li>æœç´¢ç›¸å…³æ€§åŒ¹é…</li><li>åŒå¡”ç»“æ„æ”¯æŒ User/Item å‘é‡ç¦»çº¿é¢„è®¡ç®—ï¼Œé€‚åˆçº¿ä¸Šå®æ—¶æœåŠ¡</li></ul><hr><h2 id="_2-æ•°æ®å‡†å¤‡ä¸é¢„å¤„ç†" tabindex="-1">2. æ•°æ®å‡†å¤‡ä¸é¢„å¤„ç† <a class="header-anchor" href="#_2-æ•°æ®å‡†å¤‡ä¸é¢„å¤„ç†" aria-label="Permalink to â€œ2. æ•°æ®å‡†å¤‡ä¸é¢„å¤„ç†â€">â€‹</a></h2><p>æœ¬ç¤ºä¾‹ä½¿ç”¨ <strong>MovieLens-1M</strong> æ•°æ®é›†ï¼ŒåŒ…å«çº¦ 100 ä¸‡æ¡ç”¨æˆ·å¯¹ç”µå½±çš„è¯„åˆ†è®°å½•ã€‚</p><h3 id="_2-1-åŠ è½½å’Œå¤„ç†æ•°æ®" tabindex="-1">2.1 åŠ è½½å’Œå¤„ç†æ•°æ® <a class="header-anchor" href="#_2-1-åŠ è½½å’Œå¤„ç†æ•°æ®" aria-label="Permalink to â€œ2.1 åŠ è½½å’Œå¤„ç†æ•°æ®â€">â€‹</a></h3><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> os</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> numpy </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> np</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pandas </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pd</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sklearn.preprocessing </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> LabelEncoder</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch_rechub.basic.features </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SparseFeature, SequenceFeature</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch_rechub.utils.data </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> MatchDataGenerator, df_to_dict</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch_rechub.utils.match </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> gen_model_input, generate_seq_feature_match</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># åŠ è½½ MovieLens é‡‡æ ·æ•°æ®</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">data </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pd.read_csv(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;examples/matching/data/ml-1m/ml-1m_sample.csv&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">data[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;cate_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;genres&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].apply(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">lambda</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x: x.split(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;|&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># å®šä¹‰ç¦»æ•£ç‰¹å¾</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sparse_features </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;user_id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;movie_id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;gender&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;age&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;occupation&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;zip&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;cate_id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">user_col, item_col </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;user_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;movie_id&quot;</span></span></code></pre></div><h3 id="_2-2-ç‰¹å¾ç¼–ç " tabindex="-1">2.2 ç‰¹å¾ç¼–ç  <a class="header-anchor" href="#_2-2-ç‰¹å¾ç¼–ç " aria-label="Permalink to â€œ2.2 ç‰¹å¾ç¼–ç â€">â€‹</a></h3><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">feature_max_idx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> feature </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sparse_features:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    lbe </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> LabelEncoder()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    data[feature] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lbe.fit_transform(data[feature]) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    feature_max_idx[feature] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data[feature].max() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># æå–ç”¨æˆ·/ç‰©å“ profile</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">user_profile </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data[[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;user_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;gender&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;age&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;occupation&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;zip&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]].drop_duplicates(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;user_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">item_profile </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data[[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;movie_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;cate_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]].drop_duplicates(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;movie_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><h3 id="_2-3-æ„å»ºåºåˆ—ç‰¹å¾å’Œè®­ç»ƒæ•°æ®" tabindex="-1">2.3 æ„å»ºåºåˆ—ç‰¹å¾å’Œè®­ç»ƒæ•°æ® <a class="header-anchor" href="#_2-3-æ„å»ºåºåˆ—ç‰¹å¾å’Œè®­ç»ƒæ•°æ®" aria-label="Permalink to â€œ2.3 æ„å»ºåºåˆ—ç‰¹å¾å’Œè®­ç»ƒæ•°æ®â€">â€‹</a></h3><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ç”Ÿæˆåºåˆ—ç‰¹å¾ï¼ˆç”¨æˆ·å†å²è¡Œä¸ºåºåˆ—ï¼‰å’Œè´Ÿé‡‡æ ·</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">df_train, df_test </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> generate_seq_feature_match(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    data, user_col, item_col,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    time_col</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;timestamp&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    item_attribute_cols</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[],</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    sample_method</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,    </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># éšæœºè´Ÿé‡‡æ ·</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    mode</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,             </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># point-wise</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    neg_ratio</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,        </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># è´Ÿæ ·æœ¬æ¯”ä¾‹</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    min_item</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># æ„å»ºæ¨¡å‹è¾“å…¥</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">x_train </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> gen_model_input(df_train, user_profile, user_col, item_profile, item_col, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">seq_max_len</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">50</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">y_train </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x_train[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;label&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">x_train </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {k: v </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> k, v </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x_train.items() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> k </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;label&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">x_test </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> gen_model_input(df_test, user_profile, user_col, item_profile, item_col, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">seq_max_len</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">50</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><h3 id="_2-4-å®šä¹‰ç‰¹å¾" tabindex="-1">2.4 å®šä¹‰ç‰¹å¾ <a class="header-anchor" href="#_2-4-å®šä¹‰ç‰¹å¾" aria-label="Permalink to â€œ2.4 å®šä¹‰ç‰¹å¾â€">â€‹</a></h3><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">user_cols </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;user_id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;gender&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;age&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;occupation&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;zip&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">item_cols </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;movie_id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;cate_id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ç”¨æˆ·ç‰¹å¾ = ç”¨æˆ·å±æ€§ + å†å²è¡Œä¸ºåºåˆ—</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">user_features </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    SparseFeature(name, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">vocab_size</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">feature_max_idx[name], </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">embed_dim</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">16</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> name </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user_cols</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">user_features </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    SequenceFeature(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;hist_movie_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">        vocab_size</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">feature_max_idx[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;movie_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">        embed_dim</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">16</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">        pooling</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;mean&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,           </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># åºåˆ—èšåˆæ–¹å¼</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">        shared_with</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;movie_id&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # ä¸ movie_id å…±äº« embedding</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    )</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ç‰©å“ç‰¹å¾</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">item_features </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    SparseFeature(name, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">vocab_size</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">feature_max_idx[name], </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">embed_dim</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">16</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> name </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> item_cols</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ç”¨äºè¯„ä¼°çš„å…¨é‡ç‰©å“æ•°æ®</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">all_item </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> df_to_dict(item_profile)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">test_user </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x_test</span></span></code></pre></div><h3 id="_2-5-åˆ›å»º-dataloader" tabindex="-1">2.5 åˆ›å»º DataLoader <a class="header-anchor" href="#_2-5-åˆ›å»º-dataloader" aria-label="Permalink to â€œ2.5 åˆ›å»º DataLoaderâ€">â€‹</a></h3><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">dg </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> MatchDataGenerator(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">x</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">x_train, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">y</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">y_train)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">train_dl, test_dl, item_dl </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> dg.generate_dataloader(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    test_user, all_item, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">batch_size</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4096</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><hr><h2 id="_3-æ¨¡å‹é…ç½®ä¸å‚æ•°è¯´æ˜" tabindex="-1">3. æ¨¡å‹é…ç½®ä¸å‚æ•°è¯´æ˜ <a class="header-anchor" href="#_3-æ¨¡å‹é…ç½®ä¸å‚æ•°è¯´æ˜" aria-label="Permalink to â€œ3. æ¨¡å‹é…ç½®ä¸å‚æ•°è¯´æ˜â€">â€‹</a></h2><h3 id="_3-1-åˆ›å»ºæ¨¡å‹" tabindex="-1">3.1 åˆ›å»ºæ¨¡å‹ <a class="header-anchor" href="#_3-1-åˆ›å»ºæ¨¡å‹" aria-label="Permalink to â€œ3.1 åˆ›å»ºæ¨¡å‹â€">â€‹</a></h3><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch_rechub.models.matching </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> DSSM</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">model </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DSSM(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    user_features</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">user_features,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    item_features</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">item_features,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    temperature</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.02</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    user_params</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;dims&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">256</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">128</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">64</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;activation&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;prelu&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      # PReLU æ¿€æ´»å‡½æ•°æ•ˆæœæ›´å¥½</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    item_params</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;dims&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">256</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">128</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">64</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;activation&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;prelu&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><h3 id="_3-2-å‚æ•°è¯¦è§£" tabindex="-1">3.2 å‚æ•°è¯¦è§£ <a class="header-anchor" href="#_3-2-å‚æ•°è¯¦è§£" aria-label="Permalink to â€œ3.2 å‚æ•°è¯¦è§£â€">â€‹</a></h3><table tabindex="0"><thead><tr><th>å‚æ•°</th><th>ç±»å‹</th><th>è¯´æ˜</th><th>å»ºè®®å€¼</th></tr></thead><tbody><tr><td><code>user_features</code></td><td><code>list[Feature]</code></td><td>ç”¨æˆ·ä¾§ç‰¹å¾åˆ—è¡¨</td><td>ç”¨æˆ·å±æ€§ + è¡Œä¸ºåºåˆ—</td></tr><tr><td><code>item_features</code></td><td><code>list[Feature]</code></td><td>ç‰©å“ä¾§ç‰¹å¾åˆ—è¡¨</td><td>ç‰©å“ID + å±æ€§</td></tr><tr><td><code>temperature</code></td><td><code>float</code></td><td>æ¸©åº¦ç³»æ•°ï¼Œæ§åˆ¶ç›¸ä¼¼åº¦åˆ†æ•°çš„å¹³æ»‘ç¨‹åº¦</td><td>0.02 ~ 0.1</td></tr><tr><td><code>user_params.dims</code></td><td><code>list[int]</code></td><td>User Tower MLP ç»´åº¦</td><td><code>[256, 128, 64]</code></td></tr><tr><td><code>item_params.dims</code></td><td><code>list[int]</code></td><td>Item Tower MLP ç»´åº¦</td><td><code>[256, 128, 64]</code></td></tr><tr><td><code>*_params.activation</code></td><td><code>str</code></td><td>æ¿€æ´»å‡½æ•°</td><td><code>&quot;prelu&quot;</code> æ¨è</td></tr></tbody></table><blockquote><p><strong>æ¸©åº¦ç³»æ•°</strong>: è¾ƒå°çš„æ¸©åº¦ä½¿æ¨¡å‹å¯¹æ­£è´Ÿæ ·æœ¬çš„åŒºåˆ†æ›´æ•æ„Ÿï¼Œä½†è®­ç»ƒå¯èƒ½ä¸ç¨³å®šã€‚æ¨èä» 0.02 å¼€å§‹è°ƒæ•´ã€‚</p></blockquote><hr><h2 id="_4-è®­ç»ƒè¿‡ç¨‹ä¸ä»£ç ç¤ºä¾‹" tabindex="-1">4. è®­ç»ƒè¿‡ç¨‹ä¸ä»£ç ç¤ºä¾‹ <a class="header-anchor" href="#_4-è®­ç»ƒè¿‡ç¨‹ä¸ä»£ç ç¤ºä¾‹" aria-label="Permalink to â€œ4. è®­ç»ƒè¿‡ç¨‹ä¸ä»£ç ç¤ºä¾‹â€">â€‹</a></h2><h3 id="_4-1-è®­ç»ƒæ¨¡å‹" tabindex="-1">4.1 è®­ç»ƒæ¨¡å‹ <a class="header-anchor" href="#_4-1-è®­ç»ƒæ¨¡å‹" aria-label="Permalink to â€œ4.1 è®­ç»ƒæ¨¡å‹â€">â€‹</a></h3><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch_rechub.trainers </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> MatchTrainer</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">torch.manual_seed(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2022</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">trainer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> MatchTrainer(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    model,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    mode</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,                        </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 0: point-wise, 1: pair-wise, 2: list-wise</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    optimizer_params</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;lr&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1e-4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;weight_decay&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1e-6</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    n_epoch</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    device</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;cpu&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    model_path</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;./saved/dssm/&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">trainer.fit(train_dl)</span></span></code></pre></div><h3 id="_4-2-è®­ç»ƒæ¨¡å¼è¯´æ˜" tabindex="-1">4.2 è®­ç»ƒæ¨¡å¼è¯´æ˜ <a class="header-anchor" href="#_4-2-è®­ç»ƒæ¨¡å¼è¯´æ˜" aria-label="Permalink to â€œ4.2 è®­ç»ƒæ¨¡å¼è¯´æ˜â€">â€‹</a></h3><table tabindex="0"><thead><tr><th>mode</th><th>è®­ç»ƒæ–¹å¼</th><th>æŸå¤±å‡½æ•°</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>0</td><td>Point-wise</td><td>BCE Loss</td><td>å¯¹æ¯ä¸ªæ ·æœ¬ç‹¬ç«‹è®¡ç®—</td></tr><tr><td>1</td><td>Pair-wise</td><td>BPR Loss</td><td>æ­£è´Ÿæ ·æœ¬æˆå¯¹æ¯”è¾ƒ</td></tr><tr><td>2</td><td>List-wise</td><td>Softmax Loss</td><td>å…¨å±€æ’åºä¼˜åŒ–</td></tr></tbody></table><hr><h2 id="_5-æ¨¡å‹è¯„ä¼°ä¸ç»“æœåˆ†æ" tabindex="-1">5. æ¨¡å‹è¯„ä¼°ä¸ç»“æœåˆ†æ <a class="header-anchor" href="#_5-æ¨¡å‹è¯„ä¼°ä¸ç»“æœåˆ†æ" aria-label="Permalink to â€œ5. æ¨¡å‹è¯„ä¼°ä¸ç»“æœåˆ†æâ€">â€‹</a></h2><h3 id="_5-1-ç”Ÿæˆå‘é‡å¹¶è¯„ä¼°" tabindex="-1">5.1 ç”Ÿæˆå‘é‡å¹¶è¯„ä¼° <a class="header-anchor" href="#_5-1-ç”Ÿæˆå‘é‡å¹¶è¯„ä¼°" aria-label="Permalink to â€œ5.1 ç”Ÿæˆå‘é‡å¹¶è¯„ä¼°â€">â€‹</a></h3><p>DSSM çš„è¯„ä¼°éœ€è¦å…ˆç”Ÿæˆ User å’Œ Item çš„ Embedding å‘é‡ï¼Œå†ä½¿ç”¨å‘é‡æ£€ç´¢æ–¹å¼è®¡ç®— Recall@Kã€‚</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ç”Ÿæˆ User Embedding</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">user_embedding </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> trainer.inference_embedding(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    model</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">model, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">mode</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;user&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    data_loader</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">test_dl,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    model_path</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;./saved/dssm/&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ç”Ÿæˆ Item Embedding</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">item_embedding </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> trainer.inference_embedding(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    model</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">model, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">mode</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;item&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    data_loader</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">item_dl,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    model_path</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;./saved/dssm/&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;User Embedding shape: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">user_embedding.shape</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Item Embedding shape: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">item_embedding.shape</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><h3 id="_5-2-recall-k-è¯„ä¼°" tabindex="-1">5.2 Recall@K è¯„ä¼° <a class="header-anchor" href="#_5-2-recall-k-è¯„ä¼°" aria-label="Permalink to â€œ5.2 Recall@K è¯„ä¼°â€">â€‹</a></h3><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># éœ€è¦ match_evaluation è¾…åŠ©å‡½æ•°</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ä½äº examples/matching/movielens_utils.py</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> movielens_utils </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> match_evaluation</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">match_evaluation(user_embedding, item_embedding, test_user, all_item, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">topk</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><hr><h2 id="_6-å‚æ•°è°ƒä¼˜å»ºè®®" tabindex="-1">6. å‚æ•°è°ƒä¼˜å»ºè®® <a class="header-anchor" href="#_6-å‚æ•°è°ƒä¼˜å»ºè®®" aria-label="Permalink to â€œ6. å‚æ•°è°ƒä¼˜å»ºè®®â€">â€‹</a></h2><h3 id="_6-1-å…³é”®è°ƒä¼˜ç‚¹" tabindex="-1">6.1 å…³é”®è°ƒä¼˜ç‚¹ <a class="header-anchor" href="#_6-1-å…³é”®è°ƒä¼˜ç‚¹" aria-label="Permalink to â€œ6.1 å…³é”®è°ƒä¼˜ç‚¹â€">â€‹</a></h3><ol><li><strong>æ¿€æ´»å‡½æ•°</strong>: ä½¿ç”¨ <code>&quot;prelu&quot;</code> é€šå¸¸ä¼˜äº <code>&quot;relu&quot;</code>ï¼ˆåŸè®ºæ–‡æ¨èï¼‰</li><li><strong>æ¸©åº¦ç³»æ•°</strong>: <code>0.02</code> æ˜¯ä¸€ä¸ªè¾ƒå¥½çš„èµ·ç‚¹</li><li><strong>Embedding ç»´åº¦</strong>: User å’Œ Item Tower çš„æœ€ç»ˆè¾“å‡ºç»´åº¦åº”ç›¸åŒï¼ˆç”± dims[-1] å†³å®šï¼‰</li><li><strong>è´Ÿé‡‡æ ·æ¯”ä¾‹</strong>: <code>neg_ratio=3~5</code> é€šå¸¸æ•ˆæœè¾ƒå¥½</li><li><strong>å­¦ä¹ ç‡</strong>: åŒ¹é…ä»»åŠ¡æ¨èè¾ƒå°çš„å­¦ä¹ ç‡ <code>1e-4</code></li></ol><h3 id="_6-2-å‘é‡æ£€ç´¢ä¸éƒ¨ç½²" tabindex="-1">6.2 å‘é‡æ£€ç´¢ä¸éƒ¨ç½² <a class="header-anchor" href="#_6-2-å‘é‡æ£€ç´¢ä¸éƒ¨ç½²" aria-label="Permalink to â€œ6.2 å‘é‡æ£€ç´¢ä¸éƒ¨ç½²â€">â€‹</a></h3><p>è®­ç»ƒå®Œæˆåï¼Œéœ€è¦å°† Embedding æ’å…¥å‘é‡æ£€ç´¢å¼•æ“è¿›è¡Œ ANNï¼ˆè¿‘ä¼¼æœ€è¿‘é‚»ï¼‰æœç´¢ã€‚Torch-RecHub å†…ç½®äº†å¯¹ <strong>Annoy</strong>ã€<strong>Faiss</strong> å’Œ <strong>Milvus</strong> ä¸‰ç§ä¸»æµå¼•æ“çš„å°è£…ã€‚</p><h4 id="æ–¹å¼ä¸€-annoy-è½»é‡çº§-é€‚åˆå¿«é€ŸåŸå‹" tabindex="-1">æ–¹å¼ä¸€ï¼šAnnoyï¼ˆè½»é‡çº§ï¼Œé€‚åˆå¿«é€ŸåŸå‹ï¼‰ <a class="header-anchor" href="#æ–¹å¼ä¸€-annoy-è½»é‡çº§-é€‚åˆå¿«é€ŸåŸå‹" aria-label="Permalink to â€œæ–¹å¼ä¸€ï¼šAnnoyï¼ˆè½»é‡çº§ï¼Œé€‚åˆå¿«é€ŸåŸå‹ï¼‰â€">â€‹</a></h4><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pip</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> annoy</span></span></code></pre></div><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch_rechub.utils.match </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Annoy</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># æ„å»º Annoy ç´¢å¼•</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">annoy </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Annoy(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">n_trees</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">metric</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;angular&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">annoy.fit(item_embedding)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ä¸ºå•ä¸ªç”¨æˆ·æŸ¥è¯¢ Top-10 ç›¸ä¼¼ç‰©å“</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">indices, distances </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> annoy.query(user_embedding[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">n</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Top-10 Item ç´¢å¼•: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">indices</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;å¯¹åº”è·ç¦»: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">distances</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><h4 id="æ–¹å¼äºŒ-faiss-é«˜æ€§èƒ½-æ”¯æŒ-gpu-åŠ é€Ÿ" tabindex="-1">æ–¹å¼äºŒï¼šFaissï¼ˆé«˜æ€§èƒ½ï¼Œæ”¯æŒ GPU åŠ é€Ÿï¼‰ <a class="header-anchor" href="#æ–¹å¼äºŒ-faiss-é«˜æ€§èƒ½-æ”¯æŒ-gpu-åŠ é€Ÿ" aria-label="Permalink to â€œæ–¹å¼äºŒï¼šFaissï¼ˆé«˜æ€§èƒ½ï¼Œæ”¯æŒ GPU åŠ é€Ÿï¼‰â€">â€‹</a></h4><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pip</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> faiss-cpu</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # æˆ– faiss-gpu</span></span></code></pre></div><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch_rechub.utils.match </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Faiss</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> numpy </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> np</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ç¡®ä¿ embedding æ˜¯ float32 numpy æ•°ç»„</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">item_emb_np </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> item_embedding.cpu().numpy().astype(np.float32)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">user_emb_np </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user_embedding.cpu().numpy().astype(np.float32)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># åˆ›å»º Faiss ç´¢å¼•ï¼ˆæ”¯æŒ flat / ivf / hnswï¼‰</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">faiss_index </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Faiss(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">dim</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">item_emb_np.shape[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">index_type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;flat&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">metric</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;l2&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">faiss_index.fit(item_emb_np)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># æŸ¥è¯¢ Top-10</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">indices, distances </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> faiss_index.query(user_emb_np[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">n</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Top-10 Item ç´¢å¼•: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">indices</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ä¿å­˜ / åŠ è½½ç´¢å¼•</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">faiss_index.save_index(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;item_faiss.index&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">faiss_index.load_index(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;item_faiss.index&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><blockquote><p><strong>Faiss ç´¢å¼•ç±»å‹é€‰æ‹©</strong>:</p><table tabindex="0"><thead><tr><th>ç±»å‹</th><th>ç‰¹ç‚¹</th><th>é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td><code>flat</code></td><td>ç²¾ç¡®æœç´¢ï¼Œæ— éœ€è®­ç»ƒ</td><td>æ•°æ®é‡ &lt; 100ä¸‡</td></tr><tr><td><code>ivf</code></td><td>å€’æ’ç´¢å¼•ï¼Œéœ€è®­ç»ƒ</td><td>æ•°æ®é‡ 100ä¸‡~1äº¿</td></tr><tr><td><code>hnsw</code></td><td>å›¾ç´¢å¼•ï¼Œæ— éœ€è®­ç»ƒ</td><td>é«˜å¬å›ç‡éœ€æ±‚</td></tr></tbody></table></blockquote><h4 id="æ–¹å¼ä¸‰-milvus-åˆ†å¸ƒå¼-é€‚åˆç”Ÿäº§ç¯å¢ƒ" tabindex="-1">æ–¹å¼ä¸‰ï¼šMilvusï¼ˆåˆ†å¸ƒå¼ï¼Œé€‚åˆç”Ÿäº§ç¯å¢ƒï¼‰ <a class="header-anchor" href="#æ–¹å¼ä¸‰-milvus-åˆ†å¸ƒå¼-é€‚åˆç”Ÿäº§ç¯å¢ƒ" aria-label="Permalink to â€œæ–¹å¼ä¸‰ï¼šMilvusï¼ˆåˆ†å¸ƒå¼ï¼Œé€‚åˆç”Ÿäº§ç¯å¢ƒï¼‰â€">â€‹</a></h4><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pip</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pymilvus</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># éœ€è¦å…ˆå¯åŠ¨ Milvus æœåŠ¡: https://milvus.io/docs/install_standalone-docker.md</span></span></code></pre></div><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch_rechub.utils.match </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Milvus</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># è¿æ¥ Milvus å¹¶æ’å…¥ Embedding</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">milvus </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Milvus(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">dim</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">item_embedding.shape[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">host</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;localhost&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">port</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;19530&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">milvus.fit(item_embedding)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># æŸ¥è¯¢ Top-10</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">indices, distances </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> milvus.query(user_embedding, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">n</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><h4 id="ä½¿ç”¨æ–°ç‰ˆ-serving-api-builder-indexer-æ¨¡å¼" tabindex="-1">ä½¿ç”¨æ–°ç‰ˆ Serving APIï¼ˆBuilder/Indexer æ¨¡å¼ï¼‰ <a class="header-anchor" href="#ä½¿ç”¨æ–°ç‰ˆ-serving-api-builder-indexer-æ¨¡å¼" aria-label="Permalink to â€œä½¿ç”¨æ–°ç‰ˆ Serving APIï¼ˆBuilder/Indexer æ¨¡å¼ï¼‰â€">â€‹</a></h4><p>é¡¹ç›®è¿˜æä¾›äº†æ›´æ ‡å‡†åŒ–çš„ <code>serving</code> æ¨¡å—ï¼Œç»Ÿä¸€ç®¡ç†ä¸åŒåç«¯ï¼š</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch_rechub.serving </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> builder_factory</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ä½¿ç”¨å·¥å‚å‡½æ•°åˆ›å»º Builderï¼ˆæ”¯æŒ &quot;annoy&quot; / &quot;faiss&quot; / &quot;milvus&quot;ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">builder </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> builder_factory(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;faiss&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">d</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">64</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">index_type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Flat&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">metric</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;L2&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># æ„å»ºç´¢å¼•å¹¶æŸ¥è¯¢</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">with</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> builder.from_embeddings(item_embedding) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> indexer:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    results </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> indexer.query(user_embedding[:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">k</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(results.indices, results.distances)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    indexer.save(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;item.index&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ä»æ–‡ä»¶åŠ è½½</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">with</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> builder.from_index_file(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;item.index&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> indexer:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    results </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> indexer.query(user_embedding[:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">k</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><hr><h2 id="_7-æ¨¡å‹å¯è§†åŒ–" tabindex="-1">7. æ¨¡å‹å¯è§†åŒ– <a class="header-anchor" href="#_7-æ¨¡å‹å¯è§†åŒ–" aria-label="Permalink to â€œ7. æ¨¡å‹å¯è§†åŒ–â€">â€‹</a></h2><p>Torch-RecHub å†…ç½®äº†åŸºäº <code>torchview</code> çš„æ¨¡å‹ç»“æ„å¯è§†åŒ–å·¥å…·ï¼Œå¯ä»¥ç”Ÿæˆæ¨¡å‹çš„è®¡ç®—å›¾ã€‚</p><h3 id="å®‰è£…ä¾èµ–" tabindex="-1">å®‰è£…ä¾èµ– <a class="header-anchor" href="#å®‰è£…ä¾èµ–" aria-label="Permalink to â€œå®‰è£…ä¾èµ–â€">â€‹</a></h3><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pip</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> torch-rechub[visualization]</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># è¿˜éœ€è¦å®‰è£…ç³»ç»Ÿçº§ graphviz:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Ubuntu: sudo apt-get install graphviz</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># macOS: brew install graphviz</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Windows: choco install graphviz</span></span></code></pre></div><h3 id="å¯è§†åŒ–-dssm-æ¨¡å‹" tabindex="-1">å¯è§†åŒ– DSSM æ¨¡å‹ <a class="header-anchor" href="#å¯è§†åŒ–-dssm-æ¨¡å‹" aria-label="Permalink to â€œå¯è§†åŒ– DSSM æ¨¡å‹â€">â€‹</a></h3><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch_rechub.utils.visualization </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> visualize_model</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># è‡ªåŠ¨ç”Ÿæˆè¾“å…¥å¹¶å¯è§†åŒ–ï¼ˆåœ¨ Jupyter ä¸­ç›´æ¥æ˜¾ç¤ºï¼‰</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">graph </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> visualize_model(model, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">depth</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ä¿å­˜ä¸ºå›¾ç‰‡ï¼ˆé€‚åˆè®ºæ–‡/æ–‡æ¡£ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">visualize_model(model, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">save_path</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;dssm_architecture.png&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">dpi</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">300</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ä¿å­˜ä¸º PDF</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">visualize_model(model, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">save_path</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;dssm_architecture.pdf&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><blockquote><p>å¯è§†åŒ–ä¼šè‡ªåŠ¨ä»æ¨¡å‹ä¸­æå–ç‰¹å¾ä¿¡æ¯ç”Ÿæˆ dummy inputï¼Œæ— éœ€æ‰‹åŠ¨æ„é€ è¾“å…¥æ•°æ®ã€‚</p></blockquote><h3 id="dssm-æ¶æ„å›¾" tabindex="-1">DSSM æ¶æ„å›¾ <a class="header-anchor" href="#dssm-æ¶æ„å›¾" aria-label="Permalink to â€œDSSM æ¶æ„å›¾â€">â€‹</a></h3><p><img src="/torch-rechub/img/models/dssm_arch.png" alt="DSSM æ¨¡å‹æ¶æ„å›¾"></p><hr><h2 id="_8-onnx-å¯¼å‡º" tabindex="-1">8. ONNX å¯¼å‡º <a class="header-anchor" href="#_8-onnx-å¯¼å‡º" aria-label="Permalink to â€œ8. ONNX å¯¼å‡ºâ€">â€‹</a></h2><p>å°†è®­ç»ƒå¥½çš„æ¨¡å‹å¯¼å‡ºä¸º ONNX æ ¼å¼ï¼Œç”¨äºè·¨æ¡†æ¶éƒ¨ç½²ï¼ˆå¦‚ ONNX Runtimeã€TensorRTï¼‰ã€‚</p><h3 id="å¯¼å‡ºå®Œæ•´æ¨¡å‹" tabindex="-1">å¯¼å‡ºå®Œæ•´æ¨¡å‹ <a class="header-anchor" href="#å¯¼å‡ºå®Œæ•´æ¨¡å‹" aria-label="Permalink to â€œå¯¼å‡ºå®Œæ•´æ¨¡å‹â€">â€‹</a></h3><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch_rechub.utils.onnx_export </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ONNXExporter</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">exporter </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ONNXExporter(model, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">device</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;cpu&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># å¯¼å‡ºå®Œæ•´ DSSM æ¨¡å‹</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">exporter.export(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;dssm_full.onnx&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">verbose</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">True</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><h3 id="åˆ†åˆ«å¯¼å‡º-user-tower-å’Œ-item-tower" tabindex="-1">åˆ†åˆ«å¯¼å‡º User Tower å’Œ Item Tower <a class="header-anchor" href="#åˆ†åˆ«å¯¼å‡º-user-tower-å’Œ-item-tower" aria-label="Permalink to â€œåˆ†åˆ«å¯¼å‡º User Tower å’Œ Item Towerâ€">â€‹</a></h3><p>åŒå¡”æ¨¡å‹å¯ä»¥åˆ†åˆ«å¯¼å‡ºä¸¤ä¸ª Towerï¼Œç”¨äºç‹¬ç«‹éƒ¨ç½²ï¼š</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># å¯¼å‡º User Towerï¼ˆçº¿ä¸Šå®æ—¶æ¨ç†ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">exporter.export(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;dssm_user_tower.onnx&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">mode</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;user&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># å¯¼å‡º Item Towerï¼ˆç¦»çº¿æ‰¹é‡è®¡ç®—ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">exporter.export(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;dssm_item_tower.onnx&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">mode</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;item&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><h3 id="ä½¿ç”¨-onnx-runtime-æ¨ç†" tabindex="-1">ä½¿ç”¨ ONNX Runtime æ¨ç† <a class="header-anchor" href="#ä½¿ç”¨-onnx-runtime-æ¨ç†" aria-label="Permalink to â€œä½¿ç”¨ ONNX Runtime æ¨ç†â€">â€‹</a></h3><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> onnxruntime </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ort</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> numpy </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> np</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># åŠ è½½ User Tower</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">session </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ort.InferenceSession(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;dssm_user_tower.onnx&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># æŸ¥çœ‹è¾“å…¥ä¿¡æ¯</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> inp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> session.get_inputs():</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;  </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">inp.name</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">: shape=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">inp.shape</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">, type=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">inp.type</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># æ„é€ è¾“å…¥å¹¶æ¨ç†</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">input_feed </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {inp.name: np.zeros(inp.shape, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">dtype</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">np.int64)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">              for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> inp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> session.get_inputs()}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">output </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> session.run(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">None</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, input_feed)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;User Embedding shape: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">output[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].shape</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><hr><h2 id="_9-å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ" tabindex="-1">9. å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ <a class="header-anchor" href="#_9-å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ" aria-label="Permalink to â€œ9. å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆâ€">â€‹</a></h2><h3 id="q1-user-tower-å’Œ-item-tower-çš„-dims-å¿…é¡»ç›¸åŒå—" tabindex="-1">Q1: User Tower å’Œ Item Tower çš„ dims å¿…é¡»ç›¸åŒå—ï¼Ÿ <a class="header-anchor" href="#q1-user-tower-å’Œ-item-tower-çš„-dims-å¿…é¡»ç›¸åŒå—" aria-label="Permalink to â€œQ1: User Tower å’Œ Item Tower çš„ dims å¿…é¡»ç›¸åŒå—ï¼Ÿâ€">â€‹</a></h3><p>æœ€ç»ˆè¾“å‡ºç»´åº¦ï¼ˆ<code>dims[-1]</code>ï¼‰å¿…é¡»ç›¸åŒï¼Œå› ä¸ºéœ€è¦è®¡ç®—ç›¸ä¼¼åº¦ã€‚ä¸­é—´å±‚ç»´åº¦å¯ä»¥ä¸åŒã€‚</p><h3 id="q2-å¦‚ä½•åŠ å…¥ç”¨æˆ·è¡Œä¸ºåºåˆ—ç‰¹å¾" tabindex="-1">Q2: å¦‚ä½•åŠ å…¥ç”¨æˆ·è¡Œä¸ºåºåˆ—ç‰¹å¾ï¼Ÿ <a class="header-anchor" href="#q2-å¦‚ä½•åŠ å…¥ç”¨æˆ·è¡Œä¸ºåºåˆ—ç‰¹å¾" aria-label="Permalink to â€œQ2: å¦‚ä½•åŠ å…¥ç”¨æˆ·è¡Œä¸ºåºåˆ—ç‰¹å¾ï¼Ÿâ€">â€‹</a></h3><p>ä½¿ç”¨ <code>SequenceFeature</code> å®šä¹‰å†å²è¡Œä¸ºåºåˆ—ï¼Œé€šè¿‡ <code>shared_with</code> å‚æ•°ä¸ç‰©å“ ID å…±äº« Embeddingï¼š</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SequenceFeature(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;hist_movie_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">vocab_size</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">n_movie,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">                embed_dim</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">16</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">pooling</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;mean&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">                shared_with</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;movie_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><h3 id="q3-çº¿ä¸Šå¦‚ä½•é«˜æ•ˆéƒ¨ç½²-dssm" tabindex="-1">Q3: çº¿ä¸Šå¦‚ä½•é«˜æ•ˆéƒ¨ç½² DSSMï¼Ÿ <a class="header-anchor" href="#q3-çº¿ä¸Šå¦‚ä½•é«˜æ•ˆéƒ¨ç½²-dssm" aria-label="Permalink to â€œQ3: çº¿ä¸Šå¦‚ä½•é«˜æ•ˆéƒ¨ç½² DSSMï¼Ÿâ€">â€‹</a></h3><p>å…³é”®æ€è·¯æ˜¯ <strong>User å’Œ Item è§£è€¦</strong>ï¼š</p><ol><li>ç¦»çº¿è®¡ç®—æ‰€æœ‰ Item Embeddingï¼Œå­˜å…¥å‘é‡æ•°æ®åº“ï¼ˆFaiss/Milvusï¼‰</li><li>çº¿ä¸Šç”¨ ONNX Runtime å®æ—¶è®¡ç®— User Embedding</li><li>é€šè¿‡ ANN æ£€ç´¢æœ€ç›¸ä¼¼çš„ Top-K Item</li></ol><h3 id="q4-temperature-è®¾ç½®è¿‡å°ä¼šæ€æ ·" tabindex="-1">Q4: temperature è®¾ç½®è¿‡å°ä¼šæ€æ ·ï¼Ÿ <a class="header-anchor" href="#q4-temperature-è®¾ç½®è¿‡å°ä¼šæ€æ ·" aria-label="Permalink to â€œQ4: temperature è®¾ç½®è¿‡å°ä¼šæ€æ ·ï¼Ÿâ€">â€‹</a></h3><p>temperature è¿‡å°ä¼šä½¿æ¢¯åº¦å˜å¤§ï¼Œè®­ç»ƒä¸ç¨³å®šã€‚å¦‚æœ loss å‡ºç° NaNï¼Œå°è¯•å¢å¤§ temperatureï¼ˆå¦‚ 0.05 â†’ 0.1ï¼‰ã€‚</p><h3 id="q5-annoyã€faissã€milvus-å¦‚ä½•é€‰æ‹©" tabindex="-1">Q5: Annoyã€Faissã€Milvus å¦‚ä½•é€‰æ‹©ï¼Ÿ <a class="header-anchor" href="#q5-annoyã€faissã€milvus-å¦‚ä½•é€‰æ‹©" aria-label="Permalink to â€œQ5: Annoyã€Faissã€Milvus å¦‚ä½•é€‰æ‹©ï¼Ÿâ€">â€‹</a></h3><table tabindex="0"><thead><tr><th>ç‰¹æ€§</th><th>Annoy</th><th>Faiss</th><th>Milvus</th></tr></thead><tbody><tr><td>å®‰è£…å¤æ‚åº¦</td><td>ç®€å•</td><td>ä¸­ç­‰</td><td>éœ€è¦æœåŠ¡</td></tr><tr><td>æ£€ç´¢é€Ÿåº¦</td><td>ä¸­ç­‰</td><td>å¿«ï¼ˆæ”¯æŒGPUï¼‰</td><td>å¿«</td></tr><tr><td>æ•°æ®è§„æ¨¡</td><td>&lt; ç™¾ä¸‡</td><td>äº¿çº§</td><td>äº¿çº§+åˆ†å¸ƒå¼</td></tr><tr><td>é€‚ç”¨åœºæ™¯</td><td>åŸå‹éªŒè¯</td><td>ç”Ÿäº§å•æœº</td><td>ç”Ÿäº§åˆ†å¸ƒå¼</td></tr></tbody></table><hr><h2 id="å®Œæ•´ä»£ç " tabindex="-1">å®Œæ•´ä»£ç  <a class="header-anchor" href="#å®Œæ•´ä»£ç " aria-label="Permalink to â€œå®Œæ•´ä»£ç â€">â€‹</a></h2><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> os</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> numpy </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> np</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pandas </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pd</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sklearn.preprocessing </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> LabelEncoder</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch_rechub.basic.features </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SparseFeature, SequenceFeature</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch_rechub.models.matching </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> DSSM</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch_rechub.trainers </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> MatchTrainer</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch_rechub.utils.data </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> MatchDataGenerator, df_to_dict</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> torch_rechub.utils.match </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> gen_model_input, generate_seq_feature_match, Annoy</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">():</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    torch.manual_seed(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2022</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    save_dir </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;./saved/dssm/&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    os.makedirs(save_dir, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">exist_ok</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">True</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 1. æ•°æ®å¤„ç†</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    data </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pd.read_csv(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;examples/matching/data/ml-1m/ml-1m_sample.csv&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    data[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;cate_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;genres&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].apply(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">lambda</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x: x.split(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;|&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    sparse_features </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;user_id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;movie_id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;gender&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;age&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;occupation&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;zip&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;cate_id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    user_col, item_col </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;user_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;movie_id&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    feature_max_idx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> feature </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sparse_features:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        lbe </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> LabelEncoder()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        data[feature] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lbe.fit_transform(data[feature]) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        feature_max_idx[feature] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data[feature].max() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    user_profile </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data[[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;user_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;gender&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;age&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;occupation&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;zip&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]].drop_duplicates(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;user_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    item_profile </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data[[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;movie_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;cate_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]].drop_duplicates(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;movie_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 2. æ„å»ºåºåˆ—ç‰¹å¾</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    df_train, df_test </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> generate_seq_feature_match(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        data, user_col, item_col, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">time_col</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;timestamp&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">        item_attribute_cols</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[], </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">sample_method</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">mode</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">neg_ratio</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">min_item</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    )</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    x_train </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> gen_model_input(df_train, user_profile, user_col, item_profile, item_col, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">seq_max_len</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">50</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    y_train </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x_train[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;label&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    x_train </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {k: v </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> k, v </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x_train.items() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> k </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;label&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    x_test </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> gen_model_input(df_test, user_profile, user_col, item_profile, item_col, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">seq_max_len</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">50</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 3. å®šä¹‰ç‰¹å¾</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    user_cols </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;user_id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;gender&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;age&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;occupation&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;zip&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    item_cols </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;movie_id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;cate_id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    user_features </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [SparseFeature(name, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">vocab_size</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">feature_max_idx[name], </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">embed_dim</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">16</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> name </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user_cols]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    user_features </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [SequenceFeature(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;hist_movie_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">vocab_size</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">feature_max_idx[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;movie_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">embed_dim</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">16</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">pooling</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;mean&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">shared_with</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;movie_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    item_features </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [SparseFeature(name, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">vocab_size</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">feature_max_idx[name], </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">embed_dim</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">16</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> name </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> item_cols]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    all_item </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> df_to_dict(item_profile)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    test_user </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x_test</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 4. åˆ›å»ºæ¨¡å‹</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    dg </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> MatchDataGenerator(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">x</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">x_train, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">y</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">y_train)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    model </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DSSM(user_features, item_features, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">temperature</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.02</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">                 user_params</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;dims&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">256</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">128</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">64</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;activation&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;prelu&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">},</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">                 item_params</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;dims&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">256</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">128</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">64</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;activation&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;prelu&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 5. è®­ç»ƒ</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    trainer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> MatchTrainer(model, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">mode</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">optimizer_params</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;lr&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1e-4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;weight_decay&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1e-6</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">},</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">                           n_epoch</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">device</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;cpu&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">model_path</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">save_dir)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    train_dl, test_dl, item_dl </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> dg.generate_dataloader(test_user, all_item, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">batch_size</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4096</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    trainer.fit(train_dl)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 6. ç”Ÿæˆ Embedding</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    user_embedding </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> trainer.inference_embedding(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">model</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">model, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">mode</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;user&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">data_loader</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">test_dl, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">model_path</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">save_dir)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    item_embedding </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> trainer.inference_embedding(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">model</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">model, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">mode</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;item&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">data_loader</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">item_dl, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">model_path</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">save_dir)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;User Embedding: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">user_embedding.shape</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">, Item Embedding: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">item_embedding.shape</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 7. ä½¿ç”¨ Annoy è¿›è¡Œå‘é‡å¬å›</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    annoy </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Annoy(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">n_trees</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    annoy.fit(item_embedding)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> range</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">min</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">len</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(user_embedding))):</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        indices, distances </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> annoy.query(user_embedding[i], </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">n</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;User </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">i</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -&gt; Top-10 Items: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">indices</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> __name__</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;__main__&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    main()</span></span></code></pre></div></div></div></main><footer class="VPDocFooter" data-v-7011f0d8 data-v-e257564d><!--[--><!--]--><!----><nav class="prev-next" aria-labelledby="doc-footer-aria-label" data-v-e257564d><span class="visually-hidden" id="doc-footer-aria-label" data-v-e257564d>Pager</span><div class="pager" data-v-e257564d><!----></div><div class="pager" data-v-e257564d><a class="VPLink link pager-link next" href="/torch-rechub/zh/tutorials/intro.html" data-v-e257564d><!--[--><span class="desc" data-v-e257564d>Next page</span><span class="title" data-v-e257564d>å¯¼è§ˆ (Overview)</span><!--]--></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"api_api.md\":\"BJpdh2BI\",\"blog_hllm_reproduction.md\":\"CwQDalgy\",\"blog_match.md\":\"BxXYDt9U\",\"blog_rank.md\":\"C_1nxmdM\",\"community_changelog.md\":\"BheoWmEl\",\"community_contributing.md\":\"DYv8Uqz1\",\"community_faq.md\":\"Ih0pm61V\",\"core_data.md\":\"DU-iib5E\",\"core_evaluation.md\":\"BbFyFIyT\",\"core_features.md\":\"BxN4ZVnc\",\"core_intro.md\":\"DWRJKotX\",\"guide_install.md\":\"rznfLoko\",\"guide_intro.md\":\"CG4GELey\",\"guide_quick_start.md\":\"CCU3wgXd\",\"index.md\":\"a_h5eIOa\",\"models_generative.md\":\"DY7x-hfM\",\"models_intro.md\":\"CPz1Y_0F\",\"models_matching.md\":\"DUQ-QNGZ\",\"models_mtl.md\":\"3CXz8J2_\",\"models_ranking.md\":\"Dg49FGqL\",\"serving_demo.md\":\"DMNFbZQM\",\"serving_intro.md\":\"BSu9Bm-3\",\"serving_onnx.md\":\"GcBrs3oR\",\"serving_vector_index.md\":\"DfF3PLcn\",\"tools_callbacks.md\":\"D8SUOlGw\",\"tools_intro.md\":\"CEr8YdTJ\",\"tools_tracking.md\":\"WvmpkWsG\",\"tools_visualization.md\":\"CU-KXwlc\",\"tutorials_ctr.md\":\"CTEr4pR6\",\"tutorials_intro.md\":\"kR2m2gUA\",\"tutorials_pipeline.md\":\"C9h2Lg6a\",\"tutorials_retrieval.md\":\"nHmlWvRs\",\"zh_api_api.md\":\"3RDTSGvc\",\"zh_blog_hllm_reproduction.md\":\"B0htkuXg\",\"zh_blog_hstu_reproduction.md\":\"BB_CEQ4c\",\"zh_blog_match.md\":\"fnORVM4G\",\"zh_blog_rank.md\":\"4wd45yC_\",\"zh_community_changelog.md\":\"8dey8jnH\",\"zh_community_contributing.md\":\"vUvVPDZp\",\"zh_community_faq.md\":\"CSn4D6o2\",\"zh_core_data.md\":\"Um-pen_T\",\"zh_core_evaluation.md\":\"ImYsSm1O\",\"zh_core_features.md\":\"fShq-oP8\",\"zh_core_intro.md\":\"D2rAKg0y\",\"zh_guide_install.md\":\"DCtg9E2H\",\"zh_guide_intro.md\":\"BJqAQvku\",\"zh_guide_quick_start.md\":\"DWLCr0Y1\",\"zh_index.md\":\"BxitR62D\",\"zh_models_generative.md\":\"CMAZA-nv\",\"zh_models_intro.md\":\"DLrHdsVG\",\"zh_models_matching.md\":\"DkgRi8s_\",\"zh_models_mtl.md\":\"CrE7_2ll\",\"zh_models_ranking.md\":\"CY8JaqAx\",\"zh_serving_demo.md\":\"CaD07QQK\",\"zh_serving_intro.md\":\"CXSJzHr_\",\"zh_serving_onnx.md\":\"BnRssNik\",\"zh_serving_vector_index.md\":\"X6scbh3u\",\"zh_tools_callbacks.md\":\"Gwe32dny\",\"zh_tools_intro.md\":\"BtsmiV9k\",\"zh_tools_tracking.md\":\"BA6T5obA\",\"zh_tools_visualization.md\":\"BN6YhM1B\",\"zh_tutorials_ctr.md\":\"DfeceZOL\",\"zh_tutorials_intro.md\":\"CwBYJMOL\",\"zh_tutorials_models_matching_dssm.md\":\"DHb23E4X\",\"zh_tutorials_models_matching_youtube_dnn.md\":\"BJEXAZk2\",\"zh_tutorials_models_multi_task_mmoe.md\":\"fq97Wrs1\",\"zh_tutorials_models_ranking_dcn.md\":\"C1bRelZE\",\"zh_tutorials_models_ranking_deepfm.md\":\"vN08lbek\",\"zh_tutorials_models_ranking_widedeep.md\":\"BUZH3oyh\",\"zh_tutorials_pipeline.md\":\"u-vrycKk\",\"zh_tutorials_retrieval.md\":\"CQ2na8Me\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"torch-rechub\",\"description\":\"A Lighting Pytorch Framework for Recommendation Models, Easy-to-use and Easy-to-extend.\",\"base\":\"/torch-rechub/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"logo\":\"/img/logo.png\",\"search\":{\"provider\":\"local\"},\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/datawhalechina/torch-rechub\"}]},\"locales\":{\"root\":{\"label\":\"English\",\"lang\":\"en\",\"themeConfig\":{\"nav\":[{\"text\":\"ğŸ  Home\",\"link\":\"/\"},{\"text\":\"ğŸš€ Getting Started\",\"link\":\"/guide/intro\"},{\"text\":\"âš™ï¸ Core\",\"link\":\"/core/intro\"},{\"text\":\"ğŸ° Models\",\"link\":\"/models/intro\"},{\"text\":\"ğŸ› ï¸ Tools\",\"link\":\"/tools/intro\"},{\"text\":\"ğŸš€ Serving\",\"link\":\"/serving/intro\"},{\"text\":\"ğŸ“– Tutorials\",\"link\":\"/tutorials/intro\"},{\"text\":\"â„¹ï¸ API\",\"link\":\"/api/api\"},{\"text\":\"ğŸ‘¥ Community\",\"link\":\"/community/faq\"},{\"text\":\"ğŸ“ Blog\",\"link\":\"/blog/match\"}],\"sidebar\":{\"/guide/\":[{\"text\":\"ğŸš€ Getting Started\",\"items\":[{\"text\":\"Overview\",\"link\":\"/guide/intro\"},{\"text\":\"Installation\",\"link\":\"/guide/install\"},{\"text\":\"Quick Start\",\"link\":\"/guide/quick_start\"}]}],\"/core/\":[{\"text\":\"âš™ï¸ Core Components\",\"items\":[{\"text\":\"Overview\",\"link\":\"/core/intro\"},{\"text\":\"Feature Columns\",\"link\":\"/core/features\"},{\"text\":\"Data Pipeline\",\"link\":\"/core/data\"},{\"text\":\"Training & Eval\",\"link\":\"/core/evaluation\"}]}],\"/models/\":[{\"text\":\"ğŸ° Model Zoo\",\"items\":[{\"text\":\"Overview\",\"link\":\"/models/intro\"},{\"text\":\"Ranking Models\",\"link\":\"/models/ranking\"},{\"text\":\"Matching Models\",\"link\":\"/models/matching\"},{\"text\":\"Multi-Task Models\",\"link\":\"/models/mtl\"},{\"text\":\"Generative Models\",\"link\":\"/models/generative\"}]}],\"/tools/\":[{\"text\":\"ğŸ› ï¸ Dev Tools\",\"items\":[{\"text\":\"Overview\",\"link\":\"/tools/intro\"},{\"text\":\"Visualization\",\"link\":\"/tools/visualization\"},{\"text\":\"Experiment Tracking\",\"link\":\"/tools/tracking\"},{\"text\":\"Callbacks\",\"link\":\"/tools/callbacks\"}]}],\"/serving/\":[{\"text\":\"ğŸš€ Serving\",\"items\":[{\"text\":\"Overview\",\"link\":\"/serving/intro\"},{\"text\":\"ONNX & Quantization\",\"link\":\"/serving/onnx\"},{\"text\":\"Vector Indexing\",\"link\":\"/serving/vector_index\"},{\"text\":\"Serving Demo\",\"link\":\"/serving/demo\"}]}],\"/tutorials/\":[{\"text\":\"ğŸ“– Tutorials\",\"items\":[{\"text\":\"Overview\",\"link\":\"/tutorials/intro\"},{\"text\":\"CTR Pipeline\",\"link\":\"/tutorials/ctr\"},{\"text\":\"Retrieval System\",\"link\":\"/tutorials/retrieval\"},{\"text\":\"Big Data Pipeline\",\"link\":\"/tutorials/pipeline\"}]}],\"/api/\":[{\"text\":\"â„¹ï¸ API Reference\",\"items\":[{\"text\":\"Main API\",\"link\":\"/api/api\"}]}],\"/community/\":[{\"text\":\"ğŸ“˜ Community\",\"items\":[{\"text\":\"FAQ\",\"link\":\"/community/faq\"},{\"text\":\"Contributing\",\"link\":\"/community/contributing\"},{\"text\":\"Changelog\",\"link\":\"/community/changelog\"}]}],\"/blog/\":[{\"text\":\"ğŸ“ Blog\",\"items\":[{\"text\":\"Matching Models Guide\",\"link\":\"/blog/match\"},{\"text\":\"Ranking Models Guide\",\"link\":\"/blog/rank\"},{\"text\":\"HLLM Reproduction\",\"link\":\"/blog/hllm_reproduction\"}]}]}}},\"zh\":{\"label\":\"ä¸­æ–‡\",\"lang\":\"zh-CN\",\"link\":\"/zh/\",\"themeConfig\":{\"nav\":[{\"text\":\"ğŸ  é¦–é¡µ\",\"link\":\"/zh/\"},{\"text\":\"ğŸš€ å¿«é€Ÿå…¥é—¨\",\"link\":\"/zh/guide/intro\"},{\"text\":\"âš™ï¸ æ ¸å¿ƒç»„ä»¶\",\"link\":\"/zh/core/intro\"},{\"text\":\"ğŸ° æ¨¡å‹åº“\",\"link\":\"/zh/models/intro\"},{\"text\":\"ğŸ› ï¸ ç ”å‘å·¥å…·\",\"link\":\"/zh/tools/intro\"},{\"text\":\"ğŸš€ ç”Ÿäº§éƒ¨ç½²\",\"link\":\"/zh/serving/intro\"},{\"text\":\"ğŸ“– åœºæ™¯æ•™ç¨‹\",\"link\":\"/zh/tutorials/intro\"},{\"text\":\"â„¹ï¸ API\",\"link\":\"/zh/api/api\"},{\"text\":\"ğŸ‘¥ ç¤¾åŒº\",\"link\":\"/zh/community/faq\"},{\"text\":\"ğŸ“ åšå®¢\",\"link\":\"/zh/blog/match\"}],\"sidebar\":{\"/zh/guide/\":[{\"text\":\"ğŸš€ å¿«é€Ÿå…¥é—¨\",\"items\":[{\"text\":\"å¯¼è§ˆ (Overview)\",\"link\":\"/zh/guide/intro\"},{\"text\":\"å®‰è£…æŒ‡å—\",\"link\":\"/zh/guide/install\"},{\"text\":\"3åˆ†é’Ÿä¸Šæ‰‹\",\"link\":\"/zh/guide/quick_start\"}]}],\"/zh/core/\":[{\"text\":\"âš™ï¸ æ ¸å¿ƒç»„ä»¶\",\"items\":[{\"text\":\"å¯¼è§ˆ (Overview)\",\"link\":\"/zh/core/intro\"},{\"text\":\"ç‰¹å¾å®šä¹‰ (Features)\",\"link\":\"/zh/core/features\"},{\"text\":\"æ•°æ®æµæ°´çº¿ (Data)\",\"link\":\"/zh/core/data\"},{\"text\":\"è®­ç»ƒä¸è¯„ä¼° (Eval)\",\"link\":\"/zh/core/evaluation\"}]}],\"/zh/models/\":[{\"text\":\"ğŸ° æ¨¡å‹åº“\",\"items\":[{\"text\":\"å¯¼è§ˆ (Overview)\",\"link\":\"/zh/models/intro\"},{\"text\":\"æ’åºæ¨¡å‹ (Ranking)\",\"link\":\"/zh/models/ranking\"},{\"text\":\"å¬å›æ¨¡å‹ (Matching)\",\"link\":\"/zh/models/matching\"},{\"text\":\"å¤šä»»åŠ¡æ¨¡å‹ (MTL)\",\"link\":\"/zh/models/mtl\"},{\"text\":\"ç”Ÿæˆå¼æ¨¡å‹ (Generative)\",\"link\":\"/zh/models/generative\"}]}],\"/zh/tools/\":[{\"text\":\"ğŸ› ï¸ ç ”å‘å·¥å…·\",\"items\":[{\"text\":\"å¯¼è§ˆ (Overview)\",\"link\":\"/zh/tools/intro\"},{\"text\":\"å¯è§†åŒ–ç›‘æ§\",\"link\":\"/zh/tools/visualization\"},{\"text\":\"å®éªŒè¿½è¸ª\",\"link\":\"/zh/tools/tracking\"},{\"text\":\"å›è°ƒå‡½æ•°\",\"link\":\"/zh/tools/callbacks\"}]}],\"/zh/serving/\":[{\"text\":\"ğŸš€ ç”Ÿäº§éƒ¨ç½²\",\"items\":[{\"text\":\"å¯¼è§ˆ (Overview)\",\"link\":\"/zh/serving/intro\"},{\"text\":\"ONNX å¯¼å‡ºä¸é‡åŒ–\",\"link\":\"/zh/serving/onnx\"},{\"text\":\"å‘é‡æ£€ç´¢å°è£…\",\"link\":\"/zh/serving/vector_index\"},{\"text\":\"åœ¨çº¿æœåŠ¡ç¤ºä¾‹\",\"link\":\"/zh/serving/demo\"}]}],\"/zh/tutorials/\":[{\"text\":\"ğŸ“– åœºæ™¯æ•™ç¨‹\",\"items\":[{\"text\":\"å¯¼è§ˆ (Overview)\",\"link\":\"/zh/tutorials/intro\"},{\"text\":\"CTR é¢„ä¼°æµç¨‹\",\"link\":\"/zh/tutorials/ctr\"},{\"text\":\"å¬å›ç³»ç»Ÿæ­å»º\",\"link\":\"/zh/tutorials/retrieval\"},{\"text\":\"å…¨é“¾è·¯æµæ°´çº¿\",\"link\":\"/zh/tutorials/pipeline\"}]}],\"/zh/api/\":[{\"text\":\"â„¹ï¸ API Reference\",\"items\":[{\"text\":\"API å‚è€ƒ\",\"link\":\"/zh/api/api\"}]}],\"/zh/community/\":[{\"text\":\"ğŸ“˜ ç¤¾åŒºä¿¡æ¯\",\"items\":[{\"text\":\"å¸¸è§é—®é¢˜ (FAQ)\",\"link\":\"/zh/community/faq\"},{\"text\":\"è´¡çŒ®æŒ‡å— (Contributing)\",\"link\":\"/zh/community/contributing\"},{\"text\":\"ç‰ˆæœ¬æ—¥å¿— (Changelog)\",\"link\":\"/zh/community/changelog\"}]}],\"/zh/blog/\":[{\"text\":\"ğŸ“ åšå®¢\",\"items\":[{\"text\":\"å¬å›æ¨¡å‹è®­ç»ƒæŒ‡å—\",\"link\":\"/zh/blog/match\"},{\"text\":\"æ’åºæ¨¡å‹è®­ç»ƒæŒ‡å—\",\"link\":\"/zh/blog/rank\"},{\"text\":\"HLLM å¤ç°è¯´æ˜\",\"link\":\"/zh/blog/hllm_reproduction\"},{\"text\":\"HSTU å¤ç°è¯´æ˜\",\"link\":\"/zh/blog/hstu_reproduction\"}]}]}}}},\"scrollOffset\":134,\"cleanUrls\":false,\"additionalConfig\":{}}");</script>
    
  </body>
</html>