# ===================================================================
# CI/CD æµç¨‹é…ç½® - ä»£ç è´¨é‡æ£€æŸ¥ã€æµ‹è¯•ã€æž„å»ºã€å‘å¸ƒ
# ===================================================================
# è§¦å‘æ¡ä»¶ï¼š
# - push/pull_request: è¿è¡Œå®Œæ•´ CI æ£€æŸ¥ï¼ˆlint, test, security, buildï¼‰
# - release: ä»…è¿è¡Œå‘å¸ƒæµç¨‹ï¼ˆè·³è¿‡å·²æ‰§è¡Œçš„æ£€æŸ¥ï¼‰

name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'torch_rechub/**'
      - 'tutorials/**'
      - 'examples/**'
      - 'config/**'
      - 'tests/**'
      - 'pyproject.toml'
      - '.github/workflows/ci.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'torch_rechub/**'
      - 'tutorials/**'
      - 'examples/**'
      - 'config/**'
      - 'tests/**'
      - 'pyproject.toml'
      - '.github/workflows/ci.yml'
  release:
    types: [published]

# çŽ¯å¢ƒå˜é‡
env:
  PYTHON_VERSION: '3.9'
  TORCH_INDEX_URL: 'https://download.pytorch.org/whl/cpu'

jobs:
  # ===================================================================
  # ä»£ç è´¨é‡æ£€æŸ¥ (ä»…åœ¨ push/PR æ—¶è¿è¡Œï¼Œrelease æ—¶è·³è¿‡)
  # ===================================================================
  lint:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    # è·³è¿‡ release äº‹ä»¶ï¼Œå› ä¸ºä»£ç å·²åœ¨åˆå¹¶æ—¶æ£€æŸ¥è¿‡
    if: github.event_name != 'release'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip packages
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-lint-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-lint-
            ${{ runner.os }}-pip-

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          # å®‰è£…ç‰¹å®šç‰ˆæœ¬çš„æ ¼å¼åŒ–å·¥å…·ä»¥ç¡®ä¿ä¸€è‡´æ€§ï¼ˆä¸Ž pyproject.toml ä¿æŒä¸€è‡´ï¼‰
          pip install yapf==0.43.0 isort==5.13.2 flake8>=3.8.0 mypy>=0.800 toml>=0.10.2

      - name: Format & Lint
        run: |
          # æ­¥éª¤1: isort
          isort --profile black torch_rechub/ examples/ tests/
          # æ­¥éª¤2: yapf
          yapf_style="{based_on_style: google, column_limit: 248, join_multiple_lines: false, split_all_comma_separated_values: true, split_before_logical_operator: true, dedent_closing_brackets: true, align_closing_bracket_with_visual_indent: true, indent_width: 4}"
          yapf --in-place --recursive --style="$yapf_style" torch_rechub/ examples/ tests/
          
          # æ­¥éª¤3: æ£€æŸ¥å·¥ä½œåŒºæ˜¯å¦å¹²å‡€ï¼Œç¡®è®¤æ‰€æœ‰æ ¼å¼åŒ–éƒ½å·²æäº¤
          git diff --exit-code
          
          # æ­¥éª¤4: è¿è¡Œflake8è¿›è¡Œæœ€ç»ˆçš„ä»£ç è´¨é‡æ£€æŸ¥
          flake8 --max-line-length=248 --extend-ignore=E203,W503,E501,E722,E402,F821,F523,E711,E741,F401,E265,C901,E301,E305,W293,E261,W291,W292,E111,E117,F841,E302 --max-complexity=30 torch_rechub/ examples/ tests/

      - name: Type checking (MyPy) - Optional
        continue-on-error: true
        run: |
          mypy torch_rechub/ --ignore-missing-imports

  # ===================================================================
  # å®Œæ•´æµ‹è¯• (Python 3.9) - è¿è¡Œæ‰€æœ‰æµ‹è¯•å’Œè¦†ç›–çŽ‡æŠ¥å‘Š
  # (ä»…åœ¨ push/PR æ—¶è¿è¡Œï¼Œrelease æ—¶è·³è¿‡)
  # ===================================================================
  test:
    name: Full Test Suite (Python 3.9)
    runs-on: ${{ matrix.os }}
    needs: lint
    if: github.event_name != 'release'

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    env:
      SKIP_MILVUS_TESTS: ${{ matrix.os != 'ubuntu-latest' && '1' || '0' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python 3.9
        uses: actions/setup-python@v6
        with:
          python-version: '3.9'

      - name: Cache pip packages
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/pip
            ~/.cache/torch
          key: ${{ runner.os }}-py3.9-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-py3.9-
            ${{ runner.os }}-

      - name: Install system dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Install CPU-only PyTorch for faster CI
          pip install torch --index-url ${{ env.TORCH_INDEX_URL }}
          # Install the package with dev and onnx dependencies
          pip install -e ".[dev,annoy,faiss,milvus,onnx]" || pip install -r requirements-dev.txt && pip install -e .

      - name: Start Milvus
        if: matrix.os == 'ubuntu-latest'
        run: |
          # Download the installation script
          curl -sfL https://raw.githubusercontent.com/milvus-io/milvus/master/scripts/standalone_embed.sh -o standalone_embed.sh

          # Start the Docker container
          bash standalone_embed.sh start

      - name: Wait for Milvus
        if: matrix.os == 'ubuntu-latest'
        run: |
          for i in {1..60}; do
            if curl -fsS http://localhost:9091/healthz >/dev/null; then exit 0; fi
            sleep 2
          done
          exit 1

      - name: Run tests
        if: matrix.os != 'macos-latest'
        run: |
          pytest -c config/pytest.ini tests/ -v

      - name: Run tests (skip indexing tests)
        if: matrix.os == 'macos-latest'
        run: |
          pytest -c config/pytest.ini tests/ -v --ignore=tests/test_serving.py

      - name: Run tests with coverage (Ubuntu only)
        if: matrix.os == 'ubuntu-latest'
        run: |
          pytest -c config/pytest.ini tests/ -v --cov=torch_rechub --cov-report=xml --cov-report=term

      - name: Upload coverage to Codecov
        if: matrix.os == 'ubuntu-latest'
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-umbrella

      - name: Shutdown Milvus
        if: always() && matrix.os == 'ubuntu-latest'
        run: |
          # Stop Milvus
          bash standalone_embed.sh stop

          # Delete Milvus data
          bash standalone_embed.sh delete


  # ===================================================================
  # ä¾èµ–å…¼å®¹æ€§éªŒè¯ (Python 3.10+) - ä»…éªŒè¯ä¾èµ–å®‰è£…æˆåŠŸ
  # (ä»…åœ¨ push/PR æ—¶è¿è¡Œï¼Œrelease æ—¶è·³è¿‡)
  # ===================================================================
  compatibility:
    name: Dependency Check (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    needs: lint
    if: github.event_name != 'release'

    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12', '3.13']

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Install CPU-only PyTorch for faster CI
          pip install torch --index-url ${{ env.TORCH_INDEX_URL }}
          # Verify package installation with all optional dependencies
          pip install -e ".[dev,onnx]"

      - name: Verify imports
        run: |
          python -c "import torch_rechub; print(f'torch-rechub {torch_rechub.__version__ if hasattr(torch_rechub, \"__version__\") else \"installed\"} on Python ${{ matrix.python-version }}')"
          python -c "import onnx; import onnxruntime; print('ONNX dependencies OK')"

  # ===================================================================
  # å®‰å…¨æ£€æŸ¥ (ä»…åœ¨ push/PR æ—¶è¿è¡Œï¼Œrelease æ—¶è·³è¿‡)
  # ===================================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: lint
    if: github.event_name != 'release'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install bandit
        run: |
          python -m pip install --upgrade pip
          pip install bandit

      - name: Run security scan
        run: |
          bandit -r torch_rechub/ -s B101,B311,B614 -x tests,docs,examples -f json -o bandit-report.json || true
          bandit -r torch_rechub/ -s B101,B311,B614 -x tests,docs,examples -f txt

      - name: Upload security scan results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: bandit-security-report
          path: bandit-report.json

  # ===================================================================
  # æž„å»ºæ£€æŸ¥ (ä»…åœ¨ push/PR æ—¶è¿è¡Œï¼Œrelease æ—¶è·³è¿‡)
  # ===================================================================
  build:
    name: Build Package
    runs-on: ubuntu-latest
    needs: [test, compatibility, security]
    if: github.event_name != 'release'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine wheel setuptools

      - name: Build package
        run: |
          python -m build

      - name: Check package
        run: |
          twine check dist/*

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: dist-packages
          path: dist/

  # ===================================================================
  # è‡ªåŠ¨å‘å¸ƒåˆ° PyPI å’Œ GitHub Release (ä½¿ç”¨ uv)
  # åŠŸèƒ½ï¼š
  # - ä»Ž GitHub Release è‡ªåŠ¨åŒæ­¥ç‰ˆæœ¬å·
  # - æ›´æ–° CHANGELOG.md
  # - æž„å»ºå¹¶å‘å¸ƒåˆ° PyPI
  # - ä¸Šä¼ æž„å»ºäº§ç‰©åˆ° GitHub Release é¡µé¢
  # æ³¨æ„ï¼šæ­¤ job ä»…åœ¨ release äº‹ä»¶æ—¶è¿è¡Œï¼Œä¸ä¾èµ–å…¶ä»– jobï¼ˆä»£ç å·²åœ¨åˆå¹¶æ—¶æ£€æŸ¥è¿‡ï¼‰
  # ===================================================================
  publish:
    name: Publish to PyPI & GitHub Release
    runs-on: ubuntu-latest
    # ä¸å†ä¾èµ– build jobï¼Œç›´æŽ¥è¿è¡Œï¼ˆä»£ç è´¨é‡å·²åœ¨ PR åˆå¹¶æ—¶éªŒè¯ï¼‰
    if: github.event_name == 'release' && github.event.action == 'published'
    environment: pypi
    permissions:
      id-token: write   # Required for trusted publishing
      contents: write   # Required for pushing changes and uploading release assets

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get version from tag
        id: get_version
        run: |
          # ä»Ž tag æå–ç‰ˆæœ¬å· (åŽ»æŽ‰ v å‰ç¼€)
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Version: $VERSION"

      - name: Update version in pyproject.toml
        run: |
          # æ›´æ–° pyproject.toml ä¸­çš„ç‰ˆæœ¬å·
          sed -i "s/^version = \".*\"/version = \"${{ steps.get_version.outputs.VERSION }}\"/" pyproject.toml
          echo "âœ… Updated pyproject.toml version to ${{ steps.get_version.outputs.VERSION }}"
          grep "^version" pyproject.toml

      - name: Update CHANGELOG.md
        env:
          RELEASE_BODY: ${{ github.event.release.body }}
          RELEASE_NAME: ${{ github.event.release.name }}
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          DATE=$(date +%Y-%m-%d)

          # åˆ›å»ºæ–°çš„ changelog æ¡ç›®
          NEW_ENTRY="## [${VERSION}] - ${DATE}

          ${RELEASE_BODY}

          ---

          "

          # åœ¨ç¬¬ä¸€ä¸ª --- åˆ†éš”ç¬¦ä¹‹åŽæ’å…¥æ–°ç‰ˆæœ¬è®°å½•
          awk -v entry="$NEW_ENTRY" '
            !found && /^---$/ { print; print ""; print entry; found=1; next }
            { print }
          ' CHANGELOG.md > CHANGELOG.tmp && mv CHANGELOG.tmp CHANGELOG.md

          echo "âœ… Updated CHANGELOG.md with version $VERSION"

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add pyproject.toml CHANGELOG.md

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore(release): v${{ steps.get_version.outputs.VERSION }} [skip ci]"
            git push origin main
            echo "âœ… Pushed version changes to main branch"
          fi

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Build package with uv
        id: build
        run: |
          uv build
          echo "âœ… Package built successfully"
          ls -la dist/
          # è¾“å‡ºæž„å»ºäº§ç‰©æ–‡ä»¶åä¾›åŽç»­æ­¥éª¤ä½¿ç”¨
          echo "WHEEL_FILE=$(ls dist/*.whl)" >> $GITHUB_OUTPUT
          echo "SDIST_FILE=$(ls dist/*.tar.gz)" >> $GITHUB_OUTPUT

      - name: Publish to PyPI
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          uv publish
          echo "ðŸš€ Published to PyPI successfully!"

      - name: Upload release assets to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.whl
            dist/*.tar.gz
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}